# 天猫精灵（AliGenie）控制器使用说明

## 一、概述

天猫精灵控制器实现了阿里巴巴天猫精灵 IoT 平台的智能家居设备控制协议，支持设备发现、设备控制和设备查询功能。

### 控制器信息
- **类名**：`AligenieController`
- **包路径**：`com.voice.platform.controller`
- **基础路径**：`/aligenie`
- **协议版本**：1.0

## 二、接口说明

### 1. 设备发现接口

#### 基本信息
- **端点**：`POST /aligenie/discovery`
- **功能**：获取用户的所有智能设备列表
- **认证**：需要 Bearer Token

#### 请求格式
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Discovery",
    "name": "DiscoveryDevices",
    "messageId": "msg-001",
    "payloadVersion": "1"
  },
  "payload": {}
}
```

#### 请求头
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

#### 成功响应
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Discovery",
    "name": "DiscoveryDevicesResponse",
    "messageId": "msg-001",
    "payloadVersion": "1"
  },
  "payload": {
    "devices": [
      {
        "deviceId": "device-001",
        "deviceName": "智能扫地机器人",
        "deviceType": "ROBOT_CLEANER",
        "zone": "客厅",
        "brand": "示例品牌",
        "model": "Model-X1",
        "icon": "https://example.com/icon.png",
        "properties": [
          {
            "name": "powerstate",
            "value": "on"
          }
        ],
        "actions": ["TurnOn", "TurnOff", "Pause", "Continue", "SetMode"]
      }
    ]
  }
}
```

#### 错误响应
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Error",
    "name": "ErrorResponse",
    "messageId": "msg-001",
    "payloadVersion": "1"
  },
  "payload": {
    "errorCode": "INVALID_TOKEN",
    "message": "访问令牌无效或已过期"
  }
}
```

### 2. 设备控制接口

#### 基本信息
- **端点**：`POST /aligenie/control`
- **功能**：控制智能设备执行特定操作
- **认证**：需要 Bearer Token

#### 支持的操作

##### 2.1 开机（TurnOn）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOn",
    "messageId": "msg-002",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001"
  }
}
```

##### 2.2 关机（TurnOff）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOff",
    "messageId": "msg-003",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001"
  }
}
```

##### 2.3 暂停（Pause）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "Pause",
    "messageId": "msg-004",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001"
  }
}
```

##### 2.4 继续（Continue）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "Continue",
    "messageId": "msg-005",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001"
  }
}
```

##### 2.5 设置模式（SetMode）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "SetMode",
    "messageId": "msg-006",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001",
    "mode": "auto"
  }
}
```

**支持的模式值**：
- `auto` - 自动清扫模式
- `spot` - 定点清扫模式
- `edge` - 沿边清扫模式

#### 成功响应
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOnResponse",
    "messageId": "msg-002",
    "payloadVersion": "1"
  },
  "payload": {}
}
```

### 3. 设备查询接口

#### 基本信息
- **端点**：`POST /aligenie/query`
- **功能**：查询设备当前状态
- **认证**：需要 Bearer Token

#### 请求格式
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Query",
    "name": "Query",
    "messageId": "msg-007",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001"
  }
}
```

#### 成功响应
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Query",
    "name": "QueryResponse",
    "messageId": "msg-007",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "device-001",
    "properties": [
      {
        "name": "powerstate",
        "value": "on"
      },
      {
        "name": "mode",
        "value": "auto"
      }
    ]
  }
}
```

## 三、错误代码说明

| 错误代码 | HTTP状态码 | 说明 | 解决方法 |
|---------|-----------|------|---------|
| INVALID_TOKEN | 401 | Token 无效或已过期 | 重新获取有效的 access token |
| MISSING_PARAMETER | 200 | 缺少必需参数 | 检查请求参数是否完整 |
| INVALID_MODE | 200 | 无效的模式值 | 使用支持的模式值：auto/spot/edge |
| UNSUPPORTED_ACTION | 200 | 不支持的操作 | 使用支持的操作类型 |
| INTERNAL_ERROR | 200 | 服务器内部错误 | 联系技术支持 |

## 四、使用示例

### 使用 curl 命令

#### 1. 设备发现
```bash
curl -X POST http://localhost:8080/aligenie/discovery \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Discovery",
      "name": "DiscoveryDevices",
      "messageId": "msg-001",
      "payloadVersion": "1"
    },
    "payload": {}
  }'
```

#### 2. 设备开机
```bash
curl -X POST http://localhost:8080/aligenie/control \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "TurnOn",
      "messageId": "msg-002",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "device-001"
    }
  }'
```

#### 3. 设置清扫模式
```bash
curl -X POST http://localhost:8080/aligenie/control \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "SetMode",
      "messageId": "msg-003",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "device-001",
      "mode": "auto"
    }
  }'
```

### 使用 Postman

1. 导入测试集合：`Aligenie_Test_Collection.json`
2. 设置环境变量：
   - `base_url`: `http://localhost:8080`
   - `access_token`: `test-access-token-123`
3. 运行测试用例

### 使用快速测试脚本

Windows 系统：
```bash
test-aligenie-quick.bat
```

## 五、日志说明

### 日志级别
- **INFO**：正常操作日志
- **WARN**：警告信息（如参数验证失败）
- **ERROR**：错误信息（如系统异常）

### 日志格式
```
=== 收到天猫精灵设备发现请求 ===
MessageId: msg-001
Namespace: AliGenie.Iot.Device.Discovery
Name: DiscoveryDevices
开始设备发现: userId=1
✓ 设备发现完成: userId=1, messageId=msg-001
```

### 日志查看
```bash
# 查看实时日志
tail -f logs/application.log

# 搜索特定请求
grep "msg-001" logs/application.log

# 查看错误日志
grep "ERROR" logs/application.log
```

## 六、测试指南

### 前置条件
1. 应用已启动（端口 8080）
2. 数据库已初始化
3. 测试数据已导入

### 测试步骤

#### 1. 快速测试
```bash
# 运行快速测试脚本
test-aligenie-quick.bat

# 查看测试结果
# 所有请求应返回 200 状态码
```

#### 2. 完整测试
```bash
# 使用 Postman 导入测试集合
# 文件：Aligenie_Test_Requests.json

# 运行所有测试用例
# 验证响应格式和错误处理
```

#### 3. 压力测试
```bash
# 使用 Apache Bench
ab -n 1000 -c 10 -T "application/json" \
  -H "Authorization: Bearer test-access-token-123" \
  -p discovery.json \
  http://localhost:8080/aligenie/discovery
```

### 测试检查点
- [ ] 所有接口返回正确的 HTTP 状态码
- [ ] 响应格式符合天猫精灵协议规范
- [ ] Token 验证正常工作
- [ ] 参数验证正确处理错误情况
- [ ] 日志记录完整清晰
- [ ] 错误信息准确友好

## 七、常见问题

### Q1: Token 验证失败怎么办？
**A**: 检查以下几点：
1. Token 是否正确传递（Bearer 前缀）
2. Token 是否已过期
3. Token 是否在数据库中存在

### Q2: 设备ID找不到怎么办？
**A**: 确保：
1. 设备已在数据库中注册
2. deviceId 参数正确传递
3. 用户有权限访问该设备

### Q3: 模式设置失败怎么办？
**A**: 检查：
1. mode 参数是否为支持的值（auto/spot/edge）
2. 设备是否支持该模式
3. 设备当前状态是否允许切换模式

### Q4: 如何调试接口问题？
**A**: 
1. 查看应用日志：`logs/application.log`
2. 使用 Postman 测试单个接口
3. 检查请求和响应的 JSON 格式
4. 验证数据库中的数据状态

## 八、最佳实践

### 1. Token 管理
- 定期刷新 Token
- 安全存储 Token
- 及时处理 Token 过期

### 2. 错误处理
- 捕获所有异常
- 返回友好的错误信息
- 记录详细的错误日志

### 3. 性能优化
- 使用连接池
- 实现请求缓存
- 异步处理耗时操作

### 4. 安全建议
- 使用 HTTPS 传输
- 验证请求签名
- 实现请求限流

## 九、参考资料

- [天猫精灵 IoT 开放平台文档](https://iot.aligenie.com/)
- [天猫精灵智能家居协议规范](https://iot.aligenie.com/doc)
- [OAuth 2.0 认证指南](OAuth2使用指南.md)
- [项目 API 文档](API.md)
