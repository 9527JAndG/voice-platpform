# å°åº¦æ™ºèƒ½éŸ³ç®±å¯¹æ¥æ–¹æ¡ˆ - æ‰«åœ°æœºå™¨äººæ§åˆ¶

## ğŸ“– æ–¹æ¡ˆæ¦‚è¿°

å°åº¦æ™ºèƒ½éŸ³ç®±ï¼ˆDuerOSï¼‰æ˜¯ç™¾åº¦æ¨å‡ºçš„æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹å¹³å°ï¼Œä¸å¤©çŒ«ç²¾çµç±»ä¼¼ï¼Œä¹Ÿé‡‡ç”¨ OAuth 2.0 æˆæƒ + Webhook çš„æ–¹å¼è¿›è¡Œæ™ºèƒ½å®¶å±…è®¾å¤‡å¯¹æ¥ã€‚

## ğŸ”„ å¯¹æ¯”åˆ†æï¼šå°åº¦ vs å¤©çŒ«ç²¾çµ

| å¯¹æ¯”é¡¹ | å°åº¦éŸ³ç®±ï¼ˆDuerOSï¼‰ | å¤©çŒ«ç²¾çµï¼ˆAliGenieï¼‰ |
|--------|-------------------|---------------------|
| å¼€å‘å¹³å° | ç™¾åº¦ DuerOS å¼€æ”¾å¹³å° | å¤©çŒ«ç²¾çµå¼€æ”¾å¹³å° |
| æˆæƒåè®® | OAuth 2.0 | OAuth 2.0 |
| é€šä¿¡æ–¹å¼ | HTTPS + JSON | HTTPS + JSON |
| è®¾å¤‡å‘ç° | Discovery æ¥å£ | Discovery æ¥å£ |
| è®¾å¤‡æ§åˆ¶ | Control æ¥å£ | Control æ¥å£ |
| æ ¸å¿ƒå·®å¼‚ | è¯·æ±‚/å“åº”æ ¼å¼ç•¥æœ‰ä¸åŒ | è¯·æ±‚/å“åº”æ ¼å¼ç•¥æœ‰ä¸åŒ |

## ğŸ¯ æ ¸å¿ƒæµç¨‹ï¼ˆä¸å¤©çŒ«ç²¾çµç›¸ä¼¼ï¼‰

### 1. OAuth æˆæƒæµç¨‹

```
ç”¨æˆ· â†’ å°åº¦ App â†’ æˆæƒè¯·æ±‚
                    â†“
              /authorize (å±•ç¤ºæˆæƒé¡µé¢)
                    â†“
              ç”¨æˆ·ç¡®è®¤æˆæƒ
                    â†“
              ç”Ÿæˆ code å¹¶é‡å®šå‘
                    â†“
              /token (codeæ¢token)
                    â†“
              è¿”å› access_token
```

### 2. è®¾å¤‡å‘ç°æµç¨‹

```
ç”¨æˆ·: "å°åº¦å°åº¦ï¼Œå‘ç°è®¾å¤‡"
         â”‚
         â–¼
    DuerOS å¹³å°
         â”‚
         â–¼
    POST /smarthome/discovery
    Header: Authorization: Bearer {token}
         â”‚
         â–¼
    éªŒè¯ Token â†’ æŸ¥è¯¢ç”¨æˆ·è®¾å¤‡ â†’ è¿”å›è®¾å¤‡åˆ—è¡¨
```

### 3. è®¾å¤‡æ§åˆ¶æµç¨‹

```
ç”¨æˆ·: "å°åº¦å°åº¦ï¼Œæ‰“å¼€æ‰«åœ°æœºå™¨äºº"
         â”‚
         â–¼
    DuerOS å¹³å° (è§£æè¯­éŸ³æŒ‡ä»¤)
         â”‚
         â–¼
    POST /smarthome/control
    {
      "header": {...},
      "payload": {"deviceId": "robot_001", "action": "turnOn"}
    }
         â”‚
         â–¼
    éªŒè¯ Token â†’ æ‰§è¡Œè®¾å¤‡æ“ä½œ â†’ è¿”å›ç»“æœ
```

## ğŸ“‹ å¼€å‘æ­¥éª¤

### æ­¥éª¤ 1: å‡†å¤‡å·¥ä½œ

#### 1.1 æ³¨å†Œå¼€å‘è€…è´¦å·
- è®¿é—®ç™¾åº¦ DuerOS å¼€æ”¾å¹³å°
- æ³¨å†Œå¹¶è®¤è¯å¼€å‘è€…è´¦å·
- åˆ›å»ºæ™ºèƒ½å®¶å±…æŠ€èƒ½

#### 1.2 ç¯å¢ƒå‡†å¤‡
```bash
- JDK 21+
- MySQL 8.0+
- Maven 3.6+
- å…¬ç½‘ HTTPS åœ°å€ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
```

### æ­¥éª¤ 2: å¤ç”¨å¤©çŒ«ç²¾çµé¡¹ç›®æ¶æ„

ç”±äºå°åº¦éŸ³ç®±å’Œå¤©çŒ«ç²¾çµçš„å¯¹æ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥å¤ç”¨ç°æœ‰çš„é¡¹ç›®æ¶æ„ï¼š

#### 2.1 ä¿æŒä¸å˜çš„éƒ¨åˆ†
- âœ… OAuth 2.0 æˆæƒæµç¨‹ï¼ˆå®Œå…¨ç›¸åŒï¼‰
- âœ… æ•°æ®åº“è®¾è®¡ï¼ˆå®Œå…¨ç›¸åŒï¼‰
- âœ… Service å±‚ä¸šåŠ¡é€»è¾‘ï¼ˆåŸºæœ¬ç›¸åŒï¼‰
- âœ… Repository å±‚ï¼ˆå®Œå…¨ç›¸åŒï¼‰
- âœ… æˆæƒé¡µé¢ï¼ˆå®Œå…¨ç›¸åŒï¼‰

#### 2.2 éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†
- ğŸ”„ è¯·æ±‚/å“åº” DTO æ ¼å¼ï¼ˆç•¥æœ‰å·®å¼‚ï¼‰
- ğŸ”„ Controller å±‚æ¥å£é€‚é…
- ğŸ”„ è®¾å¤‡ç±»å‹å’Œå±æ€§æ˜ å°„

### æ­¥éª¤ 3: åˆ›å»ºå°åº¦ä¸“ç”¨ Controller

åˆ›å»º `DuerOSController.java`ï¼Œé€‚é…å°åº¦çš„è¯·æ±‚æ ¼å¼ï¼š

```java
@RestController
@RequestMapping("/dueros")
public class DuerOSController {
    
    @Autowired
    private OAuthService oauthService;
    
    @Autowired
    private DeviceService deviceService;
    
    /**
     * è®¾å¤‡å‘ç°æ¥å£ï¼ˆå°åº¦æ ¼å¼ï¼‰
     */
    @PostMapping("/discovery")
    public ResponseEntity<?> discovery(
            @RequestHeader("Authorization") String authorization,
            @RequestBody DuerOSRequest request) {
        
        // éªŒè¯ Token
        String accessToken = extractToken(authorization);
        if (!oauthService.validateAccessToken(accessToken)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(createErrorResponse("INVALID_TOKEN"));
        }
        
        // è°ƒç”¨è®¾å¤‡æœåŠ¡
        Long userId = 1L; // ä» token è·å–ç”¨æˆ·ID
        DuerOSResponse response = deviceService.discoveryForDuerOS(userId);
        
        return ResponseEntity.ok(response);
    }
    
    /**
     * è®¾å¤‡æ§åˆ¶æ¥å£ï¼ˆå°åº¦æ ¼å¼ï¼‰
     */
    @PostMapping("/control")
    public ResponseEntity<?> control(
            @RequestHeader("Authorization") String authorization,
            @RequestBody DuerOSRequest request) {
        
        // éªŒè¯ Token
        String accessToken = extractToken(authorization);
        if (!oauthService.validateAccessToken(accessToken)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(createErrorResponse("INVALID_TOKEN"));
        }
        
        // è§£ææ§åˆ¶æŒ‡ä»¤
        String deviceId = request.getPayload().get("deviceId").toString();
        String action = request.getPayload().get("action").toString();
        
        // æ‰§è¡Œæ§åˆ¶
        DuerOSResponse response = deviceService.controlForDuerOS(deviceId, action);
        
        return ResponseEntity.ok(response);
    }
}
```

### æ­¥éª¤ 4: åˆ›å»ºå°åº¦ä¸“ç”¨ DTO

#### 4.1 DuerOS è¯·æ±‚å¯¹è±¡

```java
@Data
public class DuerOSRequest {
    private Header header;
    private Map<String, Object> payload;
    
    @Data
    public static class Header {
        private String namespace;
        private String name;
        private String messageId;
        private String payloadVersion;
    }
}
```

#### 4.2 DuerOS å“åº”å¯¹è±¡

```java
@Data
public class DuerOSResponse {
    private Header header;
    private Map<String, Object> payload;
    
    @Data
    public static class Header {
        private String namespace;
        private String name;
        private String messageId;
        private String payloadVersion = "1.0";
    }
    
    public static DuerOSResponse success(String namespace, String name, String messageId) {
        Header header = new Header();
        header.setNamespace(namespace);
        header.setName(name);
        header.setMessageId(messageId);
        
        Map<String, Object> payload = new HashMap<>();
        
        DuerOSResponse response = new DuerOSResponse();
        response.setHeader(header);
        response.setPayload(payload);
        
        return response;
    }
}
```

### æ­¥éª¤ 5: æ‰©å±• DeviceService

åœ¨ç°æœ‰çš„ `DeviceService` ä¸­æ·»åŠ å°åº¦ä¸“ç”¨æ–¹æ³•ï¼š

```java
/**
 * è®¾å¤‡å‘ç° - å°åº¦æ ¼å¼
 */
public DuerOSResponse discoveryForDuerOS(Long userId) {
    List<Device> devices = deviceRepository.findByUserId(userId);
    
    DuerOSResponse response = DuerOSResponse.success(
        "DuerOS.ConnectedHome.Discovery",
        "DiscoverAppliancesResponse",
        UUID.randomUUID().toString()
    );
    
    List<Map<String, Object>> discoveredAppliances = new ArrayList<>();
    
    for (Device device : devices) {
        Map<String, Object> appliance = new HashMap<>();
        appliance.put("applianceId", device.getDeviceId());
        appliance.put("manufacturerName", "è‡ªå®šä¹‰å“ç‰Œ");
        appliance.put("modelName", "æ‰«åœ°æœºå™¨äºº");
        appliance.put("version", "1.0");
        appliance.put("friendlyName", device.getDeviceName());
        appliance.put("friendlyDescription", "æ™ºèƒ½æ‰«åœ°æœºå™¨äºº");
        appliance.put("isReachable", true);
        
        // æ”¯æŒçš„æ“ä½œ
        List<String> actions = Arrays.asList(
            "turnOn", "turnOff", "pause", "continue", "setMode"
        );
        appliance.put("actions", actions);
        
        // è®¾å¤‡ç±»å‹
        appliance.put("applianceTypes", Arrays.asList("ROBOT_CLEANER"));
        
        discoveredAppliances.add(appliance);
    }
    
    response.getPayload().put("discoveredAppliances", discoveredAppliances);
    
    return response;
}

/**
 * è®¾å¤‡æ§åˆ¶ - å°åº¦æ ¼å¼
 */
public DuerOSResponse controlForDuerOS(String deviceId, String action) {
    Optional<Device> deviceOpt = deviceRepository.findByDeviceId(deviceId);
    
    if (!deviceOpt.isPresent()) {
        return createDuerOSError("DEVICE_NOT_FOUND", "è®¾å¤‡ä¸å­˜åœ¨");
    }
    
    Device device = deviceOpt.get();
    
    // æ ¹æ® action æ‰§è¡Œç›¸åº”æ“ä½œ
    switch (action) {
        case "turnOn":
            device.setPowerState("on");
            break;
        case "turnOff":
            device.setPowerState("off");
            break;
        case "pause":
            // æš‚åœé€»è¾‘
            break;
        case "continue":
            // ç»§ç»­é€»è¾‘
            break;
        default:
            return createDuerOSError("UNSUPPORTED_ACTION", "ä¸æ”¯æŒçš„æ“ä½œ");
    }
    
    deviceRepository.save(device);
    
    return DuerOSResponse.success(
        "DuerOS.ConnectedHome.Control",
        action + "Confirmation",
        UUID.randomUUID().toString()
    );
}
```

### æ­¥éª¤ 6: é…ç½®å°åº¦å¼€æ”¾å¹³å°

#### 6.1 åˆ›å»ºæŠ€èƒ½
1. ç™»å½•ç™¾åº¦ DuerOS å¼€æ”¾å¹³å°
2. åˆ›å»º"æ™ºèƒ½å®¶å±…"æŠ€èƒ½
3. å¡«å†™æŠ€èƒ½åŸºæœ¬ä¿¡æ¯

#### 6.2 é…ç½® OAuth
```
æˆæƒåœ°å€: https://your-domain.com/authorize
Token åœ°å€: https://your-domain.com/token
Client ID: xiaodu_client_id
Client Secret: xiaodu_client_secret
```

#### 6.3 é…ç½® Webhook
```
è®¾å¤‡å‘ç°æ¥å£: https://your-domain.com/dueros/discovery
è®¾å¤‡æ§åˆ¶æ¥å£: https://your-domain.com/dueros/control
```

### æ­¥éª¤ 7: æ•°æ®åº“é…ç½®

åœ¨ç°æœ‰æ•°æ®åº“ä¸­æ·»åŠ å°åº¦å®¢æˆ·ç«¯ï¼š

```sql
INSERT INTO oauth_clients (client_id, client_secret, redirect_uri, user_id) 
VALUES ('xiaodu_client_id', 'xiaodu_client_secret', 'https://dueros.baidu.com/callback', 1);
```

### æ­¥éª¤ 8: æµ‹è¯•æµç¨‹

#### 8.1 OAuth æˆæƒæµ‹è¯•
```bash
# è®¿é—®æˆæƒé¡µé¢
curl "http://localhost:8080/authorize?client_id=xiaodu_client_id&redirect_uri=https://dueros.baidu.com/callback&state=xyz&response_type=code"
```

#### 8.2 è·å– Token
```bash
curl -X POST "http://localhost:8080/token" \
  -d "grant_type=authorization_code" \
  -d "client_id=xiaodu_client_id" \
  -d "client_secret=xiaodu_client_secret" \
  -d "code=YOUR_CODE"
```

#### 8.3 è®¾å¤‡å‘ç°æµ‹è¯•
```bash
curl -X POST "http://localhost:8080/dueros/discovery" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Discovery",
      "name": "DiscoverAppliancesRequest",
      "messageId": "test-001",
      "payloadVersion": "1.0"
    },
    "payload": {}
  }'
```

#### 8.4 è®¾å¤‡æ§åˆ¶æµ‹è¯•
```bash
curl -X POST "http://localhost:8080/dueros/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Control",
      "name": "TurnOnRequest",
      "messageId": "test-002",
      "payloadVersion": "1.0"
    },
    "payload": {
      "deviceId": "robot_001",
      "action": "turnOn"
    }
  }'
```

## ğŸ® è¯­éŸ³æ§åˆ¶ç¤ºä¾‹

é…ç½®å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­éŸ³å‘½ä»¤ï¼š

- "å°åº¦å°åº¦ï¼Œæ‰“å¼€æ‰«åœ°æœºå™¨äºº"
- "å°åº¦å°åº¦ï¼Œå…³é—­æ‰«åœ°æœºå™¨äºº"
- "å°åº¦å°åº¦ï¼Œæš‚åœæ‰«åœ°æœºå™¨äºº"
- "å°åº¦å°åº¦ï¼Œç»§ç»­æ‰«åœ°"
- "å°åº¦å°åº¦ï¼Œæ‰«åœ°æœºå™¨äººåˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼"

## ğŸ“Š è¯·æ±‚å“åº”æ ¼å¼å¯¹æ¯”

### å¤©çŒ«ç²¾çµæ ¼å¼
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOn",
    "messageId": "xxx"
  },
  "payload": {
    "deviceId": "robot_001"
  }
}
```

### å°åº¦éŸ³ç®±æ ¼å¼
```json
{
  "header": {
    "namespace": "DuerOS.ConnectedHome.Control",
    "name": "TurnOnRequest",
    "messageId": "xxx",
    "payloadVersion": "1.0"
  },
  "payload": {
    "deviceId": "robot_001",
    "action": "turnOn"
  }
}
```

## ğŸ”§ å…³é”®å·®å¼‚ç‚¹

### 1. Namespace å‘½å
- å¤©çŒ«ç²¾çµ: `AliGenie.Iot.Device.*`
- å°åº¦éŸ³ç®±: `DuerOS.ConnectedHome.*`

### 2. è¯·æ±‚åç§°
- å¤©çŒ«ç²¾çµ: `TurnOn`, `TurnOff`
- å°åº¦éŸ³ç®±: `TurnOnRequest`, `TurnOffRequest`

### 3. Payload ç»“æ„
- å¤©çŒ«ç²¾çµ: ç›´æ¥åŒ…å« `deviceId`
- å°åº¦éŸ³ç®±: åŒ…å« `deviceId` å’Œ `action`

### 4. è®¾å¤‡ç±»å‹å®šä¹‰
- å¤©çŒ«ç²¾çµ: `robot_cleaner`
- å°åº¦éŸ³ç®±: `ROBOT_CLEANER`

## ğŸš€ å¿«é€Ÿè¿ç§»æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ç»Ÿä¸€é€‚é…å±‚ï¼ˆæ¨èï¼‰

åˆ›å»ºä¸€ä¸ªé€‚é…å™¨å±‚ï¼Œç»Ÿä¸€å¤„ç†ä¸¤ä¸ªå¹³å°çš„å·®å¼‚ï¼š

```java
@Service
public class VoiceAssistantAdapter {
    
    public UnifiedResponse handleRequest(String platform, UnifiedRequest request) {
        if ("aligenie".equals(platform)) {
            return handleAliGenieRequest(request);
        } else if ("dueros".equals(platform)) {
            return handleDuerOSRequest(request);
        }
        throw new UnsupportedOperationException("ä¸æ”¯æŒçš„å¹³å°");
    }
}
```

### æ–¹æ¡ˆ B: ç‹¬ç«‹ Controllerï¼ˆç®€å•ç›´æ¥ï¼‰

ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºç‹¬ç«‹çš„ Controllerï¼š
- `AligenieController` - å¤©çŒ«ç²¾çµ
- `DuerOSController` - å°åº¦éŸ³ç®±

## ğŸ“ å¼€å‘æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º DuerOSController
- [ ] åˆ›å»º DuerOS DTO ç±»
- [ ] æ‰©å±• DeviceService æ·»åŠ å°åº¦æ–¹æ³•
- [ ] åœ¨æ•°æ®åº“ä¸­æ·»åŠ å°åº¦å®¢æˆ·ç«¯
- [ ] é…ç½®å°åº¦å¼€æ”¾å¹³å°
- [ ] æµ‹è¯• OAuth æˆæƒæµç¨‹
- [ ] æµ‹è¯•è®¾å¤‡å‘ç°
- [ ] æµ‹è¯•è®¾å¤‡æ§åˆ¶
- [ ] åœ¨å°åº¦ App ä¸­æµ‹è¯•è¯­éŸ³æ§åˆ¶

## ğŸ¯ æ€»ç»“

å°åº¦éŸ³ç®±çš„å¯¹æ¥æ–¹æ¡ˆä¸å¤©çŒ«ç²¾çµéå¸¸ç›¸ä¼¼ï¼Œä¸»è¦å·®å¼‚åœ¨äºï¼š

1. **è¯·æ±‚/å“åº”æ ¼å¼**: Namespace å’Œå­—æ®µåç§°ç•¥æœ‰ä¸åŒ
2. **è®¾å¤‡ç±»å‹å®šä¹‰**: å‘½åè§„èŒƒä¸åŒ
3. **å¹³å°é…ç½®**: éœ€è¦åœ¨ä¸åŒçš„å¼€æ”¾å¹³å°é…ç½®

é€šè¿‡å¤ç”¨ç°æœ‰çš„å¤©çŒ«ç²¾çµé¡¹ç›®æ¶æ„ï¼Œåªéœ€è¦ï¼š
- æ·»åŠ å°åº¦ä¸“ç”¨çš„ Controller å’Œ DTO
- æ‰©å±• DeviceService æ·»åŠ æ ¼å¼è½¬æ¢æ–¹æ³•
- åœ¨æ•°æ®åº“ä¸­æ·»åŠ å°åº¦å®¢æˆ·ç«¯é…ç½®

å³å¯å¿«é€Ÿå®Œæˆå°åº¦éŸ³ç®±çš„å¯¹æ¥ï¼Œå®ç°ä¸€å¥—åç«¯åŒæ—¶æ”¯æŒå¤šä¸ªè¯­éŸ³å¹³å°ï¼
