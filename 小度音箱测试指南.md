# å°åº¦éŸ³ç®±æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•å‡†å¤‡

### 1. ç¯å¢ƒå‡†å¤‡
- âœ… åº”ç”¨å·²å¯åŠ¨ï¼ˆç«¯å£ 8080ï¼‰
- âœ… æ•°æ®åº“å·²é…ç½®
- âœ… å°åº¦å®¢æˆ·ç«¯å·²æ·»åŠ åˆ°æ•°æ®åº“

### 2. æ·»åŠ å°åº¦å®¢æˆ·ç«¯

```sql
INSERT INTO oauth_clients (client_id, client_secret, redirect_uri, user_id) 
VALUES ('xiaodu_client_id', 'xiaodu_client_secret', 'https://dueros.baidu.com/callback', 1)
ON DUPLICATE KEY UPDATE client_secret='xiaodu_client_secret';
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: OAuth æˆæƒæµ‹è¯•

#### 1.1 è®¿é—®æˆæƒé¡µé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
http://localhost:8080/authorize?client_id=xiaodu_client_id&redirect_uri=https://dueros.baidu.com/callback&state=test123&response_type=code
```

#### 1.2 ç‚¹å‡»æˆæƒ

ç‚¹å‡»"æˆæƒ"æŒ‰é’®åï¼Œä¼šé‡å®šå‘åˆ°ï¼š
```
https://dueros.baidu.com/callback?code=XXXXXX&state=test123
```

è®°å½•ä¸‹ `code` å‚æ•°çš„å€¼ã€‚

#### 1.3 è·å– Access Token

ä½¿ç”¨ curl æˆ– Postmanï¼š

```bash
curl -X POST "http://localhost:8080/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code" \
  -d "client_id=xiaodu_client_id" \
  -d "client_secret=xiaodu_client_secret" \
  -d "code=YOUR_CODE_HERE"
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "access_token": "abc123xyz...",
  "token_type": "Bearer",
  "expires_in": 259200,
  "refresh_token": "refresh_abc123..."
}
```

è®°å½•ä¸‹ `access_token` çš„å€¼ã€‚

### æ­¥éª¤ 2: è®¾å¤‡å‘ç°æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/dueros/discovery" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Discovery",
      "name": "DiscoverAppliancesRequest",
      "messageId": "test-discovery-001",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN"
    }
  }'
```

é¢„æœŸå“åº”ï¼š
```json
{
  "header": {
    "namespace": "DuerOS.ConnectedHome.Discovery",
    "name": "DiscoverAppliancesResponse",
    "messageId": "test-discovery-001",
    "payloadVersion": "1.0"
  },
  "payload": {
    "discoveredAppliances": [
      {
        "applianceId": "robot_001",
        "manufacturerName": "è‡ªå®šä¹‰å“ç‰Œ",
        "modelName": "æ™ºèƒ½æ‰«åœ°æœºå™¨äºº",
        "version": "1.0",
        "friendlyName": "å®¢å…æ‰«åœ°æœºå™¨äºº",
        "friendlyDescription": "æ™ºèƒ½æ‰«åœ°æœºå™¨äººï¼Œæ”¯æŒè¯­éŸ³æ§åˆ¶",
        "isReachable": true,
        "applianceTypes": ["ROBOT_CLEANER"],
        "actions": ["turnOn", "turnOff", "pause", "continue", "setMode"],
        "additionalApplianceDetails": {
          "powerState": "off",
          "workMode": "auto",
          "batteryLevel": 85
        }
      }
    ]
  }
}
```

### æ­¥éª¤ 3: è®¾å¤‡æ§åˆ¶æµ‹è¯•

#### 3.1 å¼€æœºæµ‹è¯•

```bash
curl -X POST "http://localhost:8080/dueros/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Control",
      "name": "TurnOnRequest",
      "messageId": "test-control-001",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN",
      "appliance": {
        "applianceId": "robot_001"
      }
    }
  }'
```

é¢„æœŸå“åº”ï¼š
```json
{
  "header": {
    "namespace": "DuerOS.ConnectedHome.Control",
    "name": "TurnOnConfirmation",
    "messageId": "test-control-001",
    "payloadVersion": "1.0"
  },
  "payload": {}
}
```

#### 3.2 å…³æœºæµ‹è¯•

```bash
curl -X POST "http://localhost:8080/dueros/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Control",
      "name": "TurnOffRequest",
      "messageId": "test-control-002",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN",
      "appliance": {
        "applianceId": "robot_001"
      }
    }
  }'
```

#### 3.3 æš‚åœæµ‹è¯•

```bash
curl -X POST "http://localhost:8080/dueros/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Control",
      "name": "PauseRequest",
      "messageId": "test-control-003",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN",
      "appliance": {
        "applianceId": "robot_001"
      }
    }
  }'
```

#### 3.4 ç»§ç»­æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/dueros/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Control",
      "name": "ContinueRequest",
      "messageId": "test-control-004",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN",
      "appliance": {
        "applianceId": "robot_001"
      }
    }
  }'
```

#### 3.5 è®¾ç½®æ¨¡å¼æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/dueros/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Control",
      "name": "SetModeRequest",
      "messageId": "test-control-005",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN",
      "appliance": {
        "applianceId": "robot_001"
      },
      "additionalInfo": {
        "mode": "spot"
      }
    }
  }'
```

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### OAuth æˆæƒ
- [ ] æˆæƒé¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] ç‚¹å‡»æˆæƒåæ­£å¸¸è·³è½¬
- [ ] æˆåŠŸè·å–æˆæƒç 
- [ ] æˆåŠŸæ¢å– access_token
- [ ] Token åŒ…å«æ­£ç¡®çš„å­—æ®µ

### è®¾å¤‡å‘ç°
- [ ] è¯·æ±‚æˆåŠŸè¿”å› 200
- [ ] è¿”å›è®¾å¤‡åˆ—è¡¨
- [ ] è®¾å¤‡ä¿¡æ¯å®Œæ•´
- [ ] è®¾å¤‡ç±»å‹æ­£ç¡®
- [ ] æ”¯æŒçš„æ“ä½œåˆ—è¡¨æ­£ç¡®

### è®¾å¤‡æ§åˆ¶
- [ ] å¼€æœºå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] å…³æœºå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] æš‚åœå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] ç»§ç»­å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] è®¾ç½®æ¨¡å¼å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] æ•°æ®åº“ä¸­è®¾å¤‡çŠ¶æ€å·²æ›´æ–°

### é”™è¯¯å¤„ç†
- [ ] æ— æ•ˆ Token è¿”å› 401
- [ ] è®¾å¤‡ä¸å­˜åœ¨è¿”å›é”™è¯¯
- [ ] ä¸æ”¯æŒçš„æ“ä½œè¿”å›é”™è¯¯
- [ ] é”™è¯¯ä¿¡æ¯æ ¼å¼æ­£ç¡®

## ğŸ” æ—¥å¿—æ£€æŸ¥

å¯åŠ¨åº”ç”¨åï¼ŒæŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š

```
å°åº¦è®¾å¤‡å‘ç°è¯·æ±‚: messageId=test-discovery-001
å°åº¦è®¾å¤‡å‘ç°å®Œæˆ: userId=1, deviceCount=1
å°åº¦è®¾å¤‡æ§åˆ¶è¯·æ±‚: action=TurnOnRequest, messageId=test-control-001
å°åº¦è®¾å¤‡å¼€æœº: deviceId=robot_001, deviceName=å®¢å…æ‰«åœ°æœºå™¨äºº
```

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Token éªŒè¯å¤±è´¥

**ç°è±¡**: è¿”å› 401 Unauthorized

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
3. æ£€æŸ¥ Authorization header æ ¼å¼

### é—®é¢˜ 2: è®¾å¤‡ä¸å­˜åœ¨

**ç°è±¡**: è¿”å› DEVICE_NOT_FOUND é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥è®¾å¤‡ ID æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥è®¾å¤‡
3. æ£€æŸ¥ç”¨æˆ· ID æ˜¯å¦åŒ¹é…

### é—®é¢˜ 3: ä¸æ”¯æŒçš„æ“ä½œ

**ç°è±¡**: è¿”å› UNSUPPORTED_ACTION é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ action åç§°æ˜¯å¦æ­£ç¡®
2. æŸ¥çœ‹æ”¯æŒçš„æ“ä½œåˆ—è¡¨
3. æ£€æŸ¥è¯·æ±‚æ ¼å¼æ˜¯å¦æ­£ç¡®

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### å“åº”æ—¶é—´è¦æ±‚
- OAuth æˆæƒ: < 1ç§’
- Token è·å–: < 500ms
- è®¾å¤‡å‘ç°: < 1ç§’
- è®¾å¤‡æ§åˆ¶: < 500ms

### å¹¶å‘æµ‹è¯•

ä½¿ç”¨ Apache Bench è¿›è¡Œå¹¶å‘æµ‹è¯•ï¼š

```bash
# æµ‹è¯•è®¾å¤‡å‘ç°æ¥å£
ab -n 100 -c 10 -H "Authorization: Bearer YOUR_TOKEN" \
   -p discovery.json -T application/json \
   http://localhost:8080/dueros/discovery
```

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼š

1. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
2. é…ç½®å°åº¦å¼€æ”¾å¹³å°
3. åœ¨å°åº¦ App ä¸­æµ‹è¯•
4. è¿›è¡Œè¯­éŸ³æ§åˆ¶æµ‹è¯•
5. æäº¤å®¡æ ¸

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```
æµ‹è¯•æ—¥æœŸ: 2026-02-24
æµ‹è¯•äººå‘˜: XXX
æµ‹è¯•ç¯å¢ƒ: æœ¬åœ°å¼€å‘ç¯å¢ƒ

æµ‹è¯•ç»“æœ:
âœ… OAuth æˆæƒæµç¨‹: é€šè¿‡
âœ… è®¾å¤‡å‘ç°åŠŸèƒ½: é€šè¿‡
âœ… è®¾å¤‡æ§åˆ¶åŠŸèƒ½: é€šè¿‡
âœ… é”™è¯¯å¤„ç†: é€šè¿‡

æ€§èƒ½æŒ‡æ ‡:
- å¹³å‡å“åº”æ—¶é—´: 200ms
- å¹¶å‘æ”¯æŒ: 10 QPS
- æˆåŠŸç‡: 100%

é—®é¢˜è®°å½•:
æ— 

ç»“è®º: æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
```
