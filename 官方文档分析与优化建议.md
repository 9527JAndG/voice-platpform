# äº”å¤§å¹³å°å®˜æ–¹æ–‡æ¡£æ·±åº¦åˆ†æä¸ä¼˜åŒ–å»ºè®®

> åŸºäºå®˜æ–¹æ–‡æ¡£çš„è¯¦ç»†æŠ€æœ¯è§„èŒƒå’Œæœ€ä½³å®è·µ

## ğŸ“‹ ç›®å½•

1. [æ–‡æ¡£æ¦‚è¿°](#1-æ–‡æ¡£æ¦‚è¿°)
2. [Amazon Alexa å®˜æ–¹è§„èŒƒ](#2-amazon-alexa-å®˜æ–¹è§„èŒƒ)
3. [Google Assistant å®˜æ–¹è§„èŒƒ](#3-google-assistant-å®˜æ–¹è§„èŒƒ)
4. [ä¸­å›½ä¸‰å¤§å¹³å°åˆ†æ](#4-ä¸­å›½ä¸‰å¤§å¹³å°åˆ†æ)
5. [åŸºäºå®˜æ–¹æ–‡æ¡£çš„ä¼˜åŒ–å»ºè®®](#5-åŸºäºå®˜æ–¹æ–‡æ¡£çš„ä¼˜åŒ–å»ºè®®)
6. [å®æ–½è·¯çº¿å›¾](#6-å®æ–½è·¯çº¿å›¾)

---

## 1. æ–‡æ¡£æ¦‚è¿°

### 1.1 æ–‡æ¡£æ¥æº

| å¹³å° | å®˜æ–¹æ–‡æ¡£è´¨é‡ | æ–‡æ¡£å®Œæ•´åº¦ | ç¤¾åŒºæ”¯æŒ |
|------|------------|-----------|---------|
| Amazon Alexa | â­â­â­â­â­ | 95% | æ´»è·ƒ |
| Google Assistant | â­â­â­â­â­ | 95% | æ´»è·ƒ |
| å¤©çŒ«ç²¾çµ | â­â­â­ | 60% | ä¸€èˆ¬ |
| å°åº¦éŸ³ç®± | â­â­â­ | 55% | ä¸€èˆ¬ |
| å°çˆ±åŒå­¦ | â­â­â­ | 50% | ä¸€èˆ¬ |

### 1.2 å…³é”®å‘ç°

**å›½é™…å¹³å°ï¼ˆAlexa & Googleï¼‰**ï¼š
- âœ… å®Œæ•´çš„ API æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç 
- âœ… è¯¦ç»†çš„è®¤è¯æµç¨‹è¯´æ˜
- âœ… ä¸°å¯Œçš„è®¾å¤‡ç±»å‹å’Œèƒ½åŠ›æ¥å£
- âœ… ä¸»åŠ¨çŠ¶æ€æŠ¥å‘Šæœºåˆ¶
- âœ… æœ¬åœ°æ‰§è¡Œæ”¯æŒ

**ä¸­å›½å¹³å°ï¼ˆå¤©çŒ«ç²¾çµã€å°åº¦ã€å°çˆ±ï¼‰**ï¼š
- âš ï¸ å®˜æ–¹æ–‡æ¡£è¾ƒå°‘ï¼Œä¸»è¦ä¾èµ–å¼€å‘è€…ç¤¾åŒº
- âš ï¸ API è§„èŒƒä¸å¤Ÿè¯¦ç»†
- âš ï¸ ç¼ºå°‘ä¸»åŠ¨æ¨é€æœºåˆ¶
- âš ï¸ è®¾å¤‡ç±»å‹æ”¯æŒæœ‰é™
- âœ… æ¥å…¥æµç¨‹ç›¸å¯¹ç®€å•

---

## 2. Amazon Alexa å®˜æ–¹è§„èŒƒ

### 2.1 æ ¸å¿ƒæ¶æ„

æ ¹æ® [Alexa Smart Home Skill API](https://developer.amazon.com/en-US/docs/alexa/device-apis/smart-home-general-apis.html) å®˜æ–¹æ–‡æ¡£ï¼ŒAlexa ä½¿ç”¨ä»¥ä¸‹æ¶æ„ï¼š

```
ç”¨æˆ·è¯­éŸ³ â†’ Alexa Service â†’ Smart Home Skill (Lambda/HTTPS)
                              â†“
                         OAuth 2.0 éªŒè¯
                              â†“
                         è®¾å¤‡äº‘æœåŠ¡
                              â†“
                         ç‰©ç†è®¾å¤‡
```

### 2.2 å¿…é¡»å®ç°çš„æ¥å£

#### 2.2.1 Discoveryï¼ˆè®¾å¤‡å‘ç°ï¼‰

**å®˜æ–¹è¦æ±‚**ï¼š
- å¿…é¡»å®ç° `Alexa.Discovery` æ¥å£
- æ¯ä¸ªè®¾å¤‡å¿…é¡»åŒ…å« `Alexa` æ¥å£ï¼ˆåŸºç¡€æ¥å£ï¼‰
- å¿…é¡»åŒ…å« `Alexa.EndpointHealth` æ¥å£

**æ ‡å‡†å“åº”æ ¼å¼**ï¼š
```json
{
  "event": {
    "header": {
      "namespace": "Alexa.Discovery",
      "name": "Discover.Response",
      "payloadVersion": "3",
      "messageId": "unique-message-id"
    },
    "payload": {
      "endpoints": [
        {
          "endpointId": "device-001",
          "manufacturerName": "Your Brand",
          "friendlyName": "å®¢å…æ‰«åœ°æœºå™¨äºº",
          "description": "æ™ºèƒ½æ‰«åœ°æœºå™¨äºº",
          "displayCategories": ["VACUUM_CLEANER"],
          "cookie": {},
          "capabilities": [
            {
              "type": "AlexaInterface",
              "interface": "Alexa",
              "version": "3"
            },
            {
              "type": "AlexaInterface",
              "interface": "Alexa.PowerController",
              "version": "3",
              "properties": {
                "supported": [{"name": "powerState"}],
                "proactivelyReported": true,
                "retrievable": true
              }
            },
            {
              "type": "AlexaInterface",
              "interface": "Alexa.ModeController",
              "version": "3",
              "instance": "VacuumMode",
              "properties": {
                "supported": [{"name": "mode"}],
                "proactivelyReported": true,
                "retrievable": true
              },
              "capabilityResources": {
                "friendlyNames": [
                  {
                    "@type": "text",
                    "value": {
                      "text": "Mode",
                      "locale": "en-US"
                    }
                  },
                  {
                    "@type": "text",
                    "value": {
                      "text": "æ¨¡å¼",
                      "locale": "zh-CN"
                    }
                  }
                ]
              },
              "configuration": {
                "ordered": false,
                "supportedModes": [
                  {
                    "value": "VacuumMode.Auto",
                    "modeResources": {
                      "friendlyNames": [
                        {
                          "@type": "text",
                          "value": {
                            "text": "Auto",
                            "locale": "en-US"
                          }
                        },
                        {
                          "@type": "text",
                          "value": {
                            "text": "è‡ªåŠ¨",
                            "locale": "zh-CN"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "value": "VacuumMode.Spot",
                    "modeResources": {
                      "friendlyNames": [
                        {
                          "@type": "text",
                          "value": {
                            "text": "Spot",
                            "locale": "en-US"
                          }
                        },
                        {
                          "@type": "text",
                          "value": {
                            "text": "å®šç‚¹",
                            "locale": "zh-CN"
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            },
            {
              "type": "AlexaInterface",
              "interface": "Alexa.EndpointHealth",
              "version": "3",
              "properties": {
                "supported": [{"name": "connectivity"}],
                "proactivelyReported": true,
                "retrievable": true
              }
            }
          ]
        }
      ]
    }
  }
}
```

#### 2.2.2 Controlï¼ˆè®¾å¤‡æ§åˆ¶ï¼‰

**æ”¯æŒçš„æ§åˆ¶å™¨æ¥å£**ï¼š

| æ¥å£ | ç”¨é€” | é€‚ç”¨è®¾å¤‡ |
|------|------|---------|
| `Alexa.PowerController` | å¼€å…³æ§åˆ¶ | æ‰€æœ‰å¯å¼€å…³è®¾å¤‡ |
| `Alexa.BrightnessController` | äº®åº¦æ§åˆ¶ | ç¯å…‰ |
| `Alexa.ColorController` | é¢œè‰²æ§åˆ¶ | å½©è‰²ç¯ |
| `Alexa.ThermostatController` | æ¸©æ§ | ç©ºè°ƒã€æ¸©æ§å™¨ |
| `Alexa.LockController` | é”æ§åˆ¶ | æ™ºèƒ½é” |
| `Alexa.ModeController` | æ¨¡å¼æ§åˆ¶ | æ‰«åœ°æœºå™¨äººã€é£æ‰‡ç­‰ |
| `Alexa.RangeController` | èŒƒå›´æ§åˆ¶ | é£é€Ÿã€éŸ³é‡ç­‰ |
| `Alexa.ToggleController` | å¼€å…³åˆ‡æ¢ | è‡ªå®šä¹‰åŠŸèƒ½ |

**æ§åˆ¶è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "directive": {
    "header": {
      "namespace": "Alexa.PowerController",
      "name": "TurnOn",
      "payloadVersion": "3",
      "messageId": "message-id",
      "correlationToken": "correlation-token"
    },
    "endpoint": {
      "scope": {
        "type": "BearerToken",
        "token": "access-token"
      },
      "endpointId": "device-001",
      "cookie": {}
    },
    "payload": {}
  }
}
```

**æ ‡å‡†å“åº”æ ¼å¼**ï¼š
```json
{
  "event": {
    "header": {
      "namespace": "Alexa",
      "name": "Response",
      "payloadVersion": "3",
      "messageId": "response-message-id",
      "correlationToken": "correlation-token"
    },
    "endpoint": {
      "endpointId": "device-001"
    },
    "payload": {}
  },
  "context": {
    "properties": [
      {
        "namespace": "Alexa.PowerController",
        "name": "powerState",
        "value": "ON",
        "timeOfSample": "2026-02-25T10:30:00Z",
        "uncertaintyInMilliseconds": 500
      },
      {
        "namespace": "Alexa.EndpointHealth",
        "name": "connectivity",
        "value": {
          "value": "OK"
        },
        "timeOfSample": "2026-02-25T10:30:00Z",
        "uncertaintyInMilliseconds": 0
      }
    ]
  }
}
```

#### 2.2.3 State Reportingï¼ˆçŠ¶æ€æŠ¥å‘Šï¼‰

**å®˜æ–¹è¦æ±‚**ï¼š
- å¿…é¡»å®ç° `Alexa.Authorization` æ¥å£çš„ `AcceptGrant` æŒ‡ä»¤
- è®¾å¤‡çŠ¶æ€å˜åŒ–æ—¶ï¼Œä¸»åŠ¨å‘ Alexa Event Gateway æŠ¥å‘Š
- ä½¿ç”¨ `ChangeReport` æˆ– `StateReport` äº‹ä»¶

**AcceptGrant å®ç°**ï¼š
```java
@PostMapping("/alexa")
public ResponseEntity<?> handleDirective(@RequestBody AlexaRequest request) {
    String namespace = request.getDirective().getHeader().getNamespace();
    String name = request.getDirective().getHeader().getName();
    
    if ("Alexa.Authorization".equals(namespace) && "AcceptGrant".equals(name)) {
        return handleAcceptGrant(request);
    }
    // ... å…¶ä»–æŒ‡ä»¤å¤„ç†
}

private ResponseEntity<?> handleAcceptGrant(AlexaRequest request) {
    Map<String, Object> payload = request.getDirective().getPayload();
    Map<String, String> grant = (Map<String, String>) payload.get("grant");
    
    String code = grant.get("code");
    Map<String, String> grantee = (Map<String, String>) payload.get("grantee");
    String granteeToken = grantee.get("token");
    
    // ç”¨æˆæƒç æ¢å– Alexa Access Token
    AlexaToken alexaToken = alexaTokenService.exchangeToken(code);
    
    // å­˜å‚¨ tokenï¼ˆç”¨äºåç»­çŠ¶æ€æŠ¥å‘Šï¼‰
    alexaTokenService.saveToken(granteeToken, alexaToken);
    
    return ResponseEntity.ok(AlexaResponse.acceptGrantResponse(
        request.getDirective().getHeader().getMessageId()
    ));
}
```

**ChangeReport å®ç°**ï¼š
```java
@Service
public class AlexaStateReporter {
    
    private static final String EVENT_GATEWAY_URL = 
        "https://api.amazonalexa.com/v3/events";
    
    public void reportStateChange(Device device, DeviceState oldState, DeviceState newState) {
        String token = alexaTokenService.getAlexaAccessToken(device.getUserId());
        
        AlexaChangeReport report = AlexaChangeReport.builder()
            .event(Event.builder()
                .header(Header.builder()
                    .namespace("Alexa")
                    .name("ChangeReport")
                    .payloadVersion("3")
                    .messageId(UUID.randomUUID().toString())
                    .build())
                .endpoint(Endpoint.builder()
                    .scope(Scope.bearerToken(token))
                    .endpointId(device.getDeviceId())
                    .build())
                .payload(Payload.builder()
                    .change(Change.builder()
                        .cause(Cause.physicalInteraction())
                        .properties(buildChangedProperties(oldState, newState))
                        .build())
                    .build())
                .build())
            .context(buildContext(newState))
            .build();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("Authorization", "Bearer " + token);
        
        HttpEntity<AlexaChangeReport> request = new HttpEntity<>(report, headers);
        restTemplate.postForEntity(EVENT_GATEWAY_URL, request, String.class);
    }
}
```

### 2.3 Alexa æœ€ä½³å®è·µ

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œä»¥ä¸‹æ˜¯å…³é”®æœ€ä½³å®è·µï¼š

1. **å“åº”æ—¶é—´**ï¼š< 8 ç§’ï¼ˆå»ºè®® < 2 ç§’ï¼‰
2. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨æ ‡å‡†é”™è¯¯ç±»å‹
   - `INVALID_AUTHORIZATION_CREDENTIAL`
   - `ENDPOINT_UNREACHABLE`
   - `INVALID_VALUE`
   - `TEMPERATURE_VALUE_OUT_OF_RANGE`
3. **å¤šè¯­è¨€æ”¯æŒ**ï¼šfriendlyNames å¿…é¡»åŒ…å« en-US å’Œç”¨æˆ·è¯­è¨€
4. **çŠ¶æ€ä¸€è‡´æ€§