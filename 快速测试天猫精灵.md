# 天猫精灵功能快速测试

## 测试步骤

### 1. 使用 Postman 测试（最简单）

1. **导入测试集合**
   - 打开 Postman
   - 点击 Import 按钮
   - 选择项目根目录下的 `Aligenie_Test_Collection.json` 文件
   - 导入成功后会看到"天猫精灵 API 测试集合"

2. **运行测试**
   - 展开集合，点击第一个请求"1. 获取访问令牌"
   - 点击 Send 按钮
   - Token 会自动保存到集合变量中
   - 依次点击其他请求进行测试

3. **批量运行所有测试**
   - 点击集合名称右侧的 "..." 按钮
   - 选择 "Run collection"
   - 点击 "Run" 按钮
   - 查看所有测试结果

### 2. 使用批处理脚本测试

双击运行 `test-aligenie.bat`，按照提示操作。

### 3. 手动测试（使用 curl 或 Postman）

#### 步骤 1：获取访问令牌

**请求：**
```
POST http://localhost:8080/oauth2/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=aligenie-client
&client_secret=aligenie-secret
&scope=device:control,device:read
```

**Postman 设置：**
- Method: POST
- URL: `http://localhost:8080/oauth2/token`
- Body 选择 `x-www-form-urlencoded`
- 添加以下键值对：
  - grant_type: `client_credentials`
  - client_id: `aligenie-client`
  - client_secret: `aligenie-secret`
  - scope: `device:control,device:read`

**预期响应：**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "device:control,device:read"
}
```

复制 `access_token` 的值，后续请求需要使用。

#### 步骤 2：设备发现

**请求：**
```
POST http://localhost:8080/aligenie/discovery
Content-Type: application/json
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "header": {
    "namespace": "AliGenie.Iot.Device.Discovery",
    "name": "DiscoveryDevices",
    "messageId": "test-001",
    "payloadVersion": "1"
  },
  "payload": {}
}
```

**Postman 设置：**
- Method: POST
- URL: `http://localhost:8080/aligenie/discovery`
- Headers:
  - Content-Type: `application/json`
  - Authorization: `Bearer YOUR_ACCESS_TOKEN`（替换为实际token）
- Body 选择 `raw` 和 `JSON`，粘贴上面的 JSON

**预期响应：**
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Discovery",
    "name": "DiscoveryDevicesResponse",
    "messageId": "test-001",
    "payloadVersion": "1"
  },
  "payload": {
    "devices": [
      {
        "deviceId": "robot_001",
        "deviceName": "客厅扫地机器人",
        "deviceType": "vacuum",
        ...
      }
    ]
  }
}
```

#### 步骤 3：开机

**请求：**
```
POST http://localhost:8080/aligenie/control
Content-Type: application/json
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOn",
    "messageId": "test-002",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "robot_001"
  }
}
```

**预期响应：**
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOnConfirmation",
    "messageId": "test-002",
    "payloadVersion": "1"
  },
  "payload": {}
}
```

#### 步骤 4：其他控制命令

只需修改 `header.name` 和 `payload` 即可：

**关机：**
```json
{
  "header": {
    "name": "TurnOff",
    ...
  },
  "payload": {
    "deviceId": "robot_001"
  }
}
```

**暂停：**
```json
{
  "header": {
    "name": "Pause",
    ...
  },
  "payload": {
    "deviceId": "robot_001"
  }
}
```

**继续：**
```json
{
  "header": {
    "name": "Continue",
    ...
  },
  "payload": {
    "deviceId": "robot_001"
  }
}
```

**设置模式：**
```json
{
  "header": {
    "name": "SetMode",
    ...
  },
  "payload": {
    "deviceId": "robot_001",
    "mode": "auto"
  }
}
```

模式可选值：`auto`（自动）、`spot`（定点）、`edge`（沿边）

#### 步骤 5：查询设备状态

**请求：**
```
POST http://localhost:8080/aligenie/query
Content-Type: application/json
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "header": {
    "namespace": "AliGenie.Iot.Device.Query",
    "name": "Query",
    "messageId": "test-007",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "robot_001"
  }
}
```

**预期响应：**
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Query",
    "name": "QueryResponse",
    "messageId": "test-007",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "robot_001",
    "powerState": "ON",
    "workMode": "auto",
    "batteryLevel": 85
  }
}
```

## 测试检查清单

完成以下测试项：

- [ ] 获取访问令牌成功
- [ ] 设备发现返回设备列表
- [ ] 开机命令成功
- [ ] 关机命令成功
- [ ] 暂停命令成功
- [ ] 继续命令成功
- [ ] 设置自动模式成功
- [ ] 设置定点模式成功
- [ ] 设置沿边模式成功
- [ ] 查询设备状态成功
- [ ] 无效令牌返回 401 错误
- [ ] 不存在的设备返回错误

## 常见问题

### 1. 连接被拒绝
- 确认服务已启动：`http://localhost:8080`
- 检查端口是否被占用

### 2. 401 Unauthorized
- 检查 Authorization header 格式：`Bearer YOUR_TOKEN`
- 确认 token 没有过期（有效期1小时）

### 3. 404 Not Found
- 检查 URL 路径是否正确
- 确认使用的是 POST 方法

### 4. 400 Bad Request
- 检查 JSON 格式是否正确
- 确认所有必需字段都已填写

## 成功标准

所有测试通过后，你应该能够：
- ✅ 成功获取访问令牌
- ✅ 发现所有测试设备
- ✅ 控制设备开关机
- ✅ 控制设备暂停/继续
- ✅ 切换设备工作模式
- ✅ 查询设备当前状态
- ✅ 正确处理错误情况
