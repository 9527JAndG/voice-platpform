# 小爱同学（MiAI）控制器使用说明

## 一、概述

小爱同学控制器实现了小米小爱同学 IoT 平台的智能家居设备控制协议，支持设备发现、设备控制、设备查询和健康检查功能。

### 控制器信息
- **类名**：`MiAIController`
- **包路径**：`com.voice.platform.controller`
- **基础路径**：`/miai`
- **协议版本**：1.0
- **特点**：扁平化 JSON 结构，接口格式最简洁

## 二、接口说明

### 1. 设备发现接口

#### 基本信息
- **端点**：`POST /miai/discovery`
- **功能**：获取用户的所有智能设备列表
- **认证**：需要 Bearer Token

#### 请求格式
```json
{}
```

#### 请求头
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

#### 成功响应
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "devices": [
      {
        "device_id": "device-001",
        "device_name": "智能扫地机器人",
        "device_type": "vacuum-cleaner",
        "online": true,
        "room": "客厅",
        "properties": {
          "power_state": "on",
          "work_mode": "auto",
          "battery_level": 85
        },
        "actions": ["turn-on", "turn-off", "pause", "continue", "set-mode", "query"]
      }
    ],
    "count": 1
  }
}
```

#### 错误响应
```json
{
  "code": 401,
  "message": "访问令牌无效或已过期",
  "data": {}
}
```

### 2. 设备控制接口

#### 基本信息
- **端点**：`POST /miai/control`
- **功能**：控制智能设备执行特定操作
- **认证**：需要 Bearer Token

#### 支持的操作

##### 2.1 开机（turn-on）
```json
{
  "intent": "turn-on",
  "deviceId": "device-001",
  "requestId": "req-001"
}
```

##### 2.2 关机（turn-off）
```json
{
  "intent": "turn-off",
  "deviceId": "device-001",
  "requestId": "req-002"
}
```

##### 2.3 暂停（pause）
```json
{
  "intent": "pause",
  "deviceId": "device-001",
  "requestId": "req-003"
}
```

##### 2.4 继续（continue）
```json
{
  "intent": "continue",
  "deviceId": "device-001",
  "requestId": "req-004"
}
```

##### 2.5 设置模式（set-mode）
```json
{
  "intent": "set-mode",
  "deviceId": "device-001",
  "requestId": "req-005",
  "params": {
    "mode": "auto"
  }
}
```

**支持的模式值**：
- `auto` - 自动清扫模式
- `spot` - 定点清扫模式
- `edge` - 沿边清扫模式

#### 成功响应
```json
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

### 3. 设备查询接口

#### 基本信息
- **端点**：`POST /miai/query`
- **功能**：查询设备当前状态
- **认证**：需要 Bearer Token

#### 请求格式
```json
{
  "deviceId": "device-001",
  "requestId": "req-006"
}
```

#### 成功响应
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": {
      "device_id": "device-001",
      "device_name": "智能扫地机器人",
      "power_state": "on",
      "work_mode": "auto",
      "battery_level": 85,
      "status": "online",
      "online": true
    }
  }
}
```

### 4. 健康检查接口

#### 基本信息
- **端点**：`GET /miai/health`
- **功能**：检查服务健康状态
- **认证**：无需认证

#### 请求格式
```
GET /miai/health
```

#### 成功响应
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": "ok",
    "platform": "xiaomi-miai",
    "timestamp": 1708837200000
  }
}
```

## 三、错误代码说明

| 错误代码 | HTTP状态码 | 说明 | 解决方法 |
|---------|-----------|------|---------|
| 401 | 401 | Token 无效或已过期 | 重新获取有效的 access token |
| 400 | 200 | 请求参数错误 | 检查请求参数是否完整和正确 |
| 404 | 200 | 设备不存在 | 检查设备ID是否正确 |
| 500 | 200 | 服务器内部错误 | 联系技术支持 |

## 四、使用示例

### 使用 curl 命令

#### 1. 健康检查
```bash
curl -X GET http://localhost:8080/miai/health
```

#### 2. 设备发现
```bash
curl -X POST http://localhost:8080/miai/discovery \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json"
```

#### 3. 设备开机
```bash
curl -X POST http://localhost:8080/miai/control \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json" \
  -d '{"intent":"turn-on","deviceId":"device-001","requestId":"req-001"}'
```

#### 4. 设置清扫模式
```bash
curl -X POST http://localhost:8080/miai/control \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json" \
  -d '{"intent":"set-mode","deviceId":"device-001","requestId":"req-002","params":{"mode":"auto"}}'
```

#### 5. 设备查询
```bash
curl -X POST http://localhost:8080/miai/query \
  -H "Authorization: Bearer test-access-token-123" \
  -H "Content-Type: application/json" \
  -d '{"deviceId":"device-001","requestId":"req-003"}'
```

### 使用快速测试脚本

Windows 系统：
```bash
test-miai-quick.bat
```

## 五、日志说明

### 日志格式
```
=== 收到小爱同学设备发现请求 ===
开始设备发现: userId=1
✓ 设备发现完成: userId=1, deviceCount=1
```

### 日志查看
```bash
# 查看实时日志
tail -f logs/application.log

# 搜索特定请求
grep "req-001" logs/application.log

# 查看错误日志
grep "ERROR" logs/application.log
```

## 六、小爱同学的特点

### 1. 扁平化结构
小爱同学使用最简洁的 JSON 格式，没有复杂的嵌套：
- 请求参数直接在根级别
- 不需要 header/payload 嵌套结构
- 响应使用标准的 code/message/data 格式

### 2. 命名规范
- 操作名称：小写+连字符（turn-on, set-mode）
- 设备类型：小写+连字符（vacuum-cleaner）
- 字段名称：小写+下划线（device_id, power_state）

### 3. 简单易用
- 接口数量少（4个）
- 参数简单明了
- 响应格式统一

## 七、常见问题

### Q1: 为什么小爱同学的接口格式与其他平台不同？
**A**: 小爱同学采用扁平化设计，追求简洁性。其他平台（如Alexa、DuerOS）使用嵌套结构，而小爱同学直接在根级别定义参数，减少了复杂度。

### Q2: requestId 参数有什么作用？
**A**: requestId 用于追踪和关联请求响应，便于日志查询和问题排查。建议每个请求使用唯一的 requestId。

### Q3: 如何处理设备离线的情况？
**A**: 设备状态通过 `online` 字段标识。离线设备仍可以接收控制命令，但实际执行需要等待设备上线。

## 八、最佳实践

### 1. 请求ID管理
- 使用 UUID 或时间戳生成唯一 requestId
- 在日志中记录 requestId 便于追踪
- 客户端保存 requestId 用于重试

### 2. 错误处理
- 检查响应的 code 字段判断成功/失败
- code=0 表示成功，其他值表示错误
- 根据 message 字段提示用户

### 3. 性能优化
- 批量操作时使用异步处理
- 缓存设备列表减少查询
- 合理设置请求超时时间

## 九、参考资料

- [小米 IoT 开放平台文档](https://iot.mi.com/new/doc)
- [小爱同学技能开发文档](https://xiaoai.mi.com/)
- [OAuth 2.0 认证指南](OAuth2使用指南.md)
- [项目 API 文档](API.md)
