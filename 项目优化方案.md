# å¤šå¹³å°æ™ºèƒ½éŸ³ç®±å¯¹æ¥é¡¹ç›®ä¼˜åŒ–æ–¹æ¡ˆ

> åŸºäº Home Assistant å’Œ Alexa/Google æœ€ä½³å®è·µ

## ğŸ“‹ ç›®å½•

1. [å½“å‰é¡¹ç›®åˆ†æ](#1-å½“å‰é¡¹ç›®åˆ†æ)
2. [ä¼˜åŒ–ç›®æ ‡](#2-ä¼˜åŒ–ç›®æ ‡)
3. [æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ](#3-æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ)
4. [äº”å¤§å¹³å°ä¼˜åŒ–æ–¹æ¡ˆ](#4-äº”å¤§å¹³å°ä¼˜åŒ–æ–¹æ¡ˆ)
5. [å®æ–½æ­¥éª¤](#5-å®æ–½æ­¥éª¤)
6. [ä»£ç ç¤ºä¾‹](#6-ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•æ–¹æ¡ˆ](#7-æµ‹è¯•æ–¹æ¡ˆ)
8. [éƒ¨ç½²æ–¹æ¡ˆ](#8-éƒ¨ç½²æ–¹æ¡ˆ)

---

## 1. å½“å‰é¡¹ç›®åˆ†æ

### 1.1 ç°æœ‰æ¶æ„

```
å½“å‰æ¶æ„ï¼š
â”œâ”€â”€ OAuth2 è®¤è¯å±‚ï¼ˆå·²å®Œæˆï¼‰
â”‚   â”œâ”€â”€ OAuth2AuthorizationController
â”‚   â”œâ”€â”€ OAuth2TokenController
â”‚   â””â”€â”€ OAuthControllerï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
â”œâ”€â”€ å¹³å°æ§åˆ¶å™¨å±‚ï¼ˆå·²å®Œæˆï¼‰
â”‚   â”œâ”€â”€ AligenieControllerï¼ˆå¤©çŒ«ç²¾çµï¼‰
â”‚   â”œâ”€â”€ DuerOSControllerï¼ˆå°åº¦éŸ³ç®±ï¼‰
â”‚   â”œâ”€â”€ MiAIControllerï¼ˆå°çˆ±åŒå­¦ï¼‰
â”‚   â”œâ”€â”€ AlexaControllerï¼ˆAlexaï¼‰
â”‚   â””â”€â”€ GoogleFulfillmentControllerï¼ˆGoogleï¼‰
â”œâ”€â”€ æœåŠ¡å±‚ï¼ˆå·²å®Œæˆï¼‰
â”‚   â”œâ”€â”€ DeviceService
â”‚   â”œâ”€â”€ OAuthService
â”‚   â””â”€â”€ UserService
â””â”€â”€ æ•°æ®å±‚ï¼ˆå·²å®Œæˆï¼‰
    â”œâ”€â”€ Device
    â”œâ”€â”€ User
    â””â”€â”€ OAuth ç›¸å…³è¡¨
```

### 1.2 å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜ 1ï¼šä»£ç é‡å¤åº¦é«˜
- æ¯ä¸ªå¹³å°æ§åˆ¶å™¨éƒ½æœ‰ç›¸ä¼¼çš„ token éªŒè¯é€»è¾‘
- è®¾å¤‡å‘ç°é€»è¾‘åœ¨å„å¹³å°é‡å¤å®ç°
- å‘½ä»¤å¤„ç†é€»è¾‘åˆ†æ•£

#### é—®é¢˜ 2ï¼šæ‰©å±•æ€§ä¸è¶³
- æ·»åŠ æ–°å¹³å°éœ€è¦ä¿®æ”¹å¤šå¤„ä»£ç 
- æ·»åŠ æ–°è®¾å¤‡ç±»å‹éœ€è¦ä¿®æ”¹æ‰€æœ‰å¹³å°æ§åˆ¶å™¨
- èƒ½åŠ›æ˜ å°„ç¡¬ç¼–ç 

#### é—®é¢˜ 3ï¼šç¼ºå°‘ç»Ÿä¸€æŠ½è±¡
- æ²¡æœ‰ç»Ÿä¸€çš„è®¾å¤‡æ¨¡å‹
- æ²¡æœ‰ç»Ÿä¸€çš„å‘½ä»¤æ¨¡å‹
- å¹³å°å·®å¼‚å¤„ç†åˆ†æ•£

#### é—®é¢˜ 4ï¼šæµ‹è¯•è¦†ç›–ä¸è¶³
- ç¼ºå°‘å•å…ƒæµ‹è¯•
- ç¼ºå°‘é›†æˆæµ‹è¯•
- ç¼ºå°‘å¹³å°å…¼å®¹æ€§æµ‹è¯•

#### é—®é¢˜ 5ï¼šç›‘æ§å’Œæ—¥å¿—ä¸å®Œå–„
- ç¼ºå°‘è¯·æ±‚è¿½è¸ª
- ç¼ºå°‘æ€§èƒ½ç›‘æ§
- é”™è¯¯æ—¥å¿—ä¸å¤Ÿè¯¦ç»†

---

## 2. ä¼˜åŒ–ç›®æ ‡

### 2.1 æ ¸å¿ƒç›®æ ‡

1. âœ… **æé«˜ä»£ç å¤ç”¨ç‡**ï¼šä»å½“å‰ 80% æå‡åˆ° 90%+
2. âœ… **å¢å¼ºæ‰©å±•æ€§**ï¼šæ–°å¢å¹³å°åªéœ€æ·»åŠ é€‚é…å™¨
3. âœ… **ç»Ÿä¸€æŠ½è±¡å±‚**ï¼šè®¾å¤‡ã€å‘½ä»¤ã€èƒ½åŠ›ç»Ÿä¸€å»ºæ¨¡
4. âœ… **å®Œå–„æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡ 80%+
5. âœ… **å¢å¼ºç›‘æ§**ï¼šå®Œæ•´çš„è¯·æ±‚è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§

### 2.2 æ€§èƒ½ç›®æ ‡

- å“åº”æ—¶é—´ï¼š< 200msï¼ˆP95ï¼‰
- å¹¶å‘æ”¯æŒï¼š1000+ QPS
- å¯ç”¨æ€§ï¼š99.9%+

### 2.3 åŠŸèƒ½ç›®æ ‡

- æ”¯æŒæ›´å¤šè®¾å¤‡ç±»å‹ï¼ˆç¯å…‰ã€å¼€å…³ã€ç©ºè°ƒç­‰ï¼‰
- æ”¯æŒåœºæ™¯è”åŠ¨
- æ”¯æŒè®¾å¤‡åˆ†ç»„
- æ”¯æŒå¤šç”¨æˆ·ç®¡ç†

---

## 3. æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 ä¼˜åŒ–åçš„æ¶æ„

```
ä¼˜åŒ–åæ¶æ„ï¼š
â”œâ”€â”€ API å±‚ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
â”‚   â””â”€â”€ PlatformDispatcherï¼ˆå¹³å°åˆ†å‘å™¨ï¼‰
â”‚
â”œâ”€â”€ å¹³å°é€‚é…å±‚ï¼ˆå¯æ’æ‹”ï¼‰
â”‚   â”œâ”€â”€ AligenieAdapter
â”‚   â”œâ”€â”€ DuerOSAdapter
â”‚   â”œâ”€â”€ MiAIAdapter
â”‚   â”œâ”€â”€ AlexaAdapter
â”‚   â””â”€â”€ GoogleAdapter
â”‚
â”œâ”€â”€ æ ¸å¿ƒä¸šåŠ¡å±‚ï¼ˆç»Ÿä¸€æŠ½è±¡ï¼‰
â”‚   â”œâ”€â”€ DeviceManagerï¼ˆè®¾å¤‡ç®¡ç†å™¨ï¼‰
â”‚   â”œâ”€â”€ CommandExecutorï¼ˆå‘½ä»¤æ‰§è¡Œå™¨ï¼‰
â”‚   â”œâ”€â”€ CapabilityMapperï¼ˆèƒ½åŠ›æ˜ å°„å™¨ï¼‰
â”‚   â””â”€â”€ StateReporterï¼ˆçŠ¶æ€æŠ¥å‘Šå™¨ï¼‰
â”‚
â”œâ”€â”€ æœåŠ¡å±‚ï¼ˆå…±äº«æœåŠ¡ï¼‰
â”‚   â”œâ”€â”€ OAuth2Service
â”‚   â”œâ”€â”€ UserService
â”‚   â””â”€â”€ CacheService
â”‚
â””â”€â”€ æ•°æ®å±‚
    â”œâ”€â”€ Deviceï¼ˆå¢å¼ºï¼‰
    â”œâ”€â”€ DeviceCapabilityï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ DeviceStateï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ Platformï¼ˆæ–°å¢ï¼‰
```

### 3.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼

#### æ¨¡å¼ 1ï¼šç­–ç•¥æ¨¡å¼ï¼ˆPlatform Adapterï¼‰
```java
public interface PlatformAdapter {
    String getPlatformName();
    DiscoveryResponse handleDiscovery(DiscoveryRequest request);
    ControlResponse handleControl(ControlRequest request);
    QueryResponse handleQuery(QueryRequest request);
}
```

#### æ¨¡å¼ 2ï¼šå·¥å‚æ¨¡å¼ï¼ˆDevice Factoryï¼‰
```java
public interface DeviceFactory {
    SmartDevice createDevice(DeviceType type, Map<String, Object> config);
}
```

#### æ¨¡å¼ 3ï¼šè§‚å¯Ÿè€…æ¨¡å¼ï¼ˆState Changeï¼‰
```java
public interface StateChangeListener {
    void onStateChanged(Device device, DeviceState oldState, DeviceState newState);
}
```

#### æ¨¡å¼ 4ï¼šå‘½ä»¤æ¨¡å¼ï¼ˆDevice Commandï¼‰
```java
public interface DeviceCommand {
    CommandResult execute(Device device);
    void undo();
}
```

---

## 4. äº”å¤§å¹³å°ä¼˜åŒ–æ–¹æ¡ˆ

### 4.1 å¤©çŒ«ç²¾çµï¼ˆAliGenieï¼‰ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- å“åº”æ ¼å¼ä¸å¤Ÿæ ‡å‡†
- ç¼ºå°‘é”™è¯¯å¤„ç†
- æ²¡æœ‰çŠ¶æ€ç¼“å­˜

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ ‡å‡†åŒ–å“åº”æ ¼å¼**
```java
public class AligenieAdapter implements PlatformAdapter {
    
    @Override
    public DiscoveryResponse handleDiscovery(DiscoveryRequest request) {
        List<Device> devices = deviceManager.getUserDevices(request.getUserId());
        
        AligenieResponse response = AligenieResponse.builder()
            .header(buildHeader(request.getMessageId()))
            .payload(buildPayload(devices))
            .build();
        
        return new DiscoveryResponse(response);
    }
    
    private AligeniePayload buildPayload(List<Device> devices) {
        List<AligenieDevice> aligenieDevices = devices.stream()
            .map(this::convertToAligenieDevice)
            .collect(Collectors.toList());
        
        return AligeniePayload.builder()
            .devices(aligenieDevices)
            .build();
    }
    
    private AligenieDevice convertToAligenieDevice(Device device) {
        return AligenieDevice.builder()
            .deviceId(device.getDeviceId())
            .deviceName(device.getDeviceName())
            .deviceType(mapDeviceType(device.getType()))
            .zone(device.getRoom())
            .brand(device.getBrand())
            .model(device.getModel())
            .icon(device.getIcon())
            .properties(mapProperties(device))
            .actions(mapActions(device))
            .build();
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå¢åŠ é”™è¯¯å¤„ç†**
```java
@ControllerAdvice
public class AligenieExceptionHandler {
    
    @ExceptionHandler(DeviceNotFoundException.class)
    public ResponseEntity<AligenieResponse> handleDeviceNotFound(
        DeviceNotFoundException ex, HttpServletRequest request
    ) {
        String messageId = extractMessageId(request);
        
        AligenieResponse response = AligenieResponse.error(
            messageId,
            "DEVICE_NOT_FOUND",
            "è®¾å¤‡ä¸å­˜åœ¨ï¼š" + ex.getDeviceId()
        );
        
        return ResponseEntity.ok(response);
    }
    
    @ExceptionHandler(InvalidTokenException.class)
    public ResponseEntity<AligenieResponse> handleInvalidToken(
        InvalidTokenException ex, HttpServletRequest request
    ) {
        String messageId = extractMessageId(request);
        
        AligenieResponse response = AligenieResponse.error(
            messageId,
            "INVALID_TOKEN",
            "è®¿é—®ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ"
        );
        
        return ResponseEntity.status(401).body(response);
    }
}
```

**æ–¹æ¡ˆ 3ï¼šæ·»åŠ çŠ¶æ€ç¼“å­˜**
```java
@Service
public class DeviceStateCache {
    
    @Autowired
    private RedisTemplate<String, DeviceState> redisTemplate;
    
    private static final String CACHE_PREFIX = "device:state:";
    private static final Duration CACHE_TTL = Duration.ofMinutes(5);
    
    public void cacheState(String deviceId, DeviceState state) {
        String key = CACHE_PREFIX + deviceId;
        redisTemplate.opsForValue().set(key, state, CACHE_TTL);
    }
    
    public Optional<DeviceState> getState(String deviceId) {
        String key = CACHE_PREFIX + deviceId;
        DeviceState state = redisTemplate.opsForValue().get(key);
        return Optional.ofNullable(state);
    }
    
    public void invalidate(String deviceId) {
        String key = CACHE_PREFIX + deviceId;
        redisTemplate.delete(key);
    }
}
```

### 4.2 å°åº¦éŸ³ç®±ï¼ˆDuerOSï¼‰ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- è®¾å¤‡ç±»å‹æ˜ å°„ä¸å®Œæ•´
- ç¼ºå°‘åœºæ™¯æ”¯æŒ
- å“åº”é€Ÿåº¦æ…¢

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå®Œå–„è®¾å¤‡ç±»å‹æ˜ å°„**
```yaml
# dueros-device-mapping.yml
device_types:
  vacuum_cleaner:
    dueros_type: "CLEANING_ROBOT"
    actions:
      - "turnOn"
      - "turnOff"
      - "pause"
      - "continue"
      - "setMode"
    attributes:
      - name: "mode"
        values: ["auto", "spot", "edge"]
      - name: "battery"
        type: "integer"
        range: [0, 100]
  
  light:
    dueros_type: "LIGHT"
    actions:
      - "turnOn"
      - "turnOff"
      - "setBrightness"
      - "setColor"
    attributes:
      - name: "brightness"
        type: "integer"
        range: [0, 100]
      - name: "color"
        type: "string"
```

**æ–¹æ¡ˆ 2ï¼šæ·»åŠ åœºæ™¯æ”¯æŒ**
```java
@Service
public class SceneService {
    
    public void executeScene(String sceneId, Long userId) {
        Scene scene = sceneRepository.findById(sceneId)
            .orElseThrow(() -> new SceneNotFoundException(sceneId));
        
        // éªŒè¯åœºæ™¯æ‰€æœ‰è€…
        if (!scene.getUserId().equals(userId)) {
            throw new UnauthorizedException("æ— æƒè®¿é—®æ­¤åœºæ™¯");
        }
        
        // æ‰§è¡Œåœºæ™¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œ
        for (SceneAction action : scene.getActions()) {
            executeAction(action);
        }
    }
    
    private void executeAction(SceneAction action) {
        Device device = deviceRepository.findById(action.getDeviceId())
            .orElseThrow(() -> new DeviceNotFoundException(action.getDeviceId()));
        
        DeviceCommand command = commandFactory.createCommand(
            action.getActionType(),
            action.getParams()
        );
        
        commandExecutor.execute(device, command);
    }
}
```

**æ–¹æ¡ˆ 3ï¼šä¼˜åŒ–å“åº”é€Ÿåº¦**
```java
@Service
public class DuerOSService {
    
    @Autowired
    private DeviceStateCache stateCache;
    
    @Autowired
    private AsyncTaskExecutor asyncExecutor;
    
    public DuerOSResponse handleControl(DuerOSRequest request) {
        String deviceId = request.getPayload().getDeviceId();
        String action = request.getHeader().getName();
        
        // 1. å¿«é€Ÿè¿”å›å“åº”ï¼ˆä¹è§‚é”ï¼‰
        DuerOSResponse response = DuerOSResponse.success(
            request.getHeader().getMessageId()
        );
        
        // 2. å¼‚æ­¥æ‰§è¡Œå®é™…æ§åˆ¶
        asyncExecutor.execute(() -> {
            try {
                deviceService.executeAction(deviceId, action, request.getPayload());
                
                // 3. æ›´æ–°ç¼“å­˜
                DeviceState newState = deviceService.getDeviceState(deviceId);
                stateCache.cacheState(deviceId, newState);
                
            } catch (Exception e) {
                log.error("å¼‚æ­¥æ‰§è¡Œè®¾å¤‡æ§åˆ¶å¤±è´¥", e);
                // å¯ä»¥è€ƒè™‘æ¨é€é”™è¯¯é€šçŸ¥
            }
        });
        
        return response;
    }
}
```

### 4.3 å°çˆ±åŒå­¦ï¼ˆMiAIï¼‰ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- ç¼ºå°‘è®¾å¤‡åˆ†ç»„
- æ²¡æœ‰å®ç°è®¾å¤‡çŠ¶æ€æŸ¥è¯¢
- é”™è¯¯ä¿¡æ¯ä¸å¤Ÿå‹å¥½

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ·»åŠ è®¾å¤‡åˆ†ç»„**
```java
@Entity
@Table(name = "device_groups")
public class DeviceGroup {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String groupId;
    private String groupName;
    private Long userId;
    private String room;
    
    @ManyToMany
    @JoinTable(
        name = "group_devices",
        joinColumns = @JoinColumn(name = "group_id"),
        inverseJoinColumns = @JoinColumn(name = "device_id")
    )
    private List<Device> devices;
}

@Service
public class DeviceGroupService {
    
    public void controlGroup(String groupId, String action, Map<String, Object> params) {
        DeviceGroup group = groupRepository.findByGroupId(groupId)
            .orElseThrow(() -> new GroupNotFoundException(groupId));
        
        // å¹¶è¡Œæ§åˆ¶ç»„å†…æ‰€æœ‰è®¾å¤‡
        group.getDevices().parallelStream()
            .forEach(device -> {
                try {
                    deviceService.executeAction(device.getDeviceId(), action, params);
                } catch (Exception e) {
                    log.error("æ§åˆ¶è®¾å¤‡å¤±è´¥: {}", device.getDeviceId(), e);
                }
            });
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå®ç°çŠ¶æ€æŸ¥è¯¢**
```java
public class MiAIAdapter implements PlatformAdapter {
    
    @Override
    public QueryResponse handleQuery(QueryRequest request) {
        String deviceId = request.getDeviceId();
        
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        Optional<DeviceState> cachedState = stateCache.getState(deviceId);
        if (cachedState.isPresent()) {
            return buildQueryResponse(cachedState.get());
        }
        
        // 2. ä»æ•°æ®åº“è·å–
        Device device = deviceRepository.findByDeviceId(deviceId)
            .orElseThrow(() -> new DeviceNotFoundException(deviceId));
        
        DeviceState state = DeviceState.builder()
            .online(device.getStatus().equals("online"))
            .powerState(device.getPowerState())
            .workMode(device.getWorkMode())
            .batteryLevel(device.getBatteryLevel())
            .build();
        
        // 3. æ›´æ–°ç¼“å­˜
        stateCache.cacheState(deviceId, state);
        
        return buildQueryResponse(state);
    }
    
    private QueryResponse buildQueryResponse(DeviceState state) {
        MiAIResponse response = MiAIResponse.builder()
            .status(0)
            .message("success")
            .data(Map.of(
                "online", state.isOnline(),
                "power", state.getPowerState(),
                "mode", state.getWorkMode(),
                "battery", state.getBatteryLevel()
            ))
            .build();
        
        return new QueryResponse(response);
    }
}
```

### 4.4 Amazon Alexa ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- èƒ½åŠ›æ¥å£ä¸å®Œæ•´
- ç¼ºå°‘çŠ¶æ€æŠ¥å‘Š
- æ²¡æœ‰å®ç° Alexa Event Gateway

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå®Œå–„èƒ½åŠ›æ¥å£**
```java
public class AlexaCapabilityBuilder {
    
    public List<Capability> buildCapabilities(Device device) {
        List<Capability> capabilities = new ArrayList<>();
        
        // åŸºç¡€ Alexa æ¥å£ï¼ˆæ‰€æœ‰è®¾å¤‡å¿…é¡»ï¼‰
        capabilities.add(buildAlexaInterface());
        
        // æ ¹æ®è®¾å¤‡ç±»å‹æ·»åŠ èƒ½åŠ›
        switch (device.getType()) {
            case VACUUM_CLEANER:
                capabilities.add(buildPowerController());
                capabilities.add(buildModeController("VacuumMode", 
                    Arrays.asList("auto", "spot", "edge")));
                capabilities.add(buildRangeController("FanSpeed", 1, 3));
                break;
            
            case LIGHT:
                capabilities.add(buildPowerController());
                if (device.supportsBrightness()) {
                    capabilities.add(buildBrightnessController());
                }
                if (device.supportsColor()) {
                    capabilities.add(buildColorController());
                    capabilities.add(buildColorTemperatureController());
                }
                break;
            
            case THERMOSTAT:
                capabilities.add(buildThermostatController());
                capabilities.add(buildTemperatureSensor());
                break;
            
            case LOCK:
                capabilities.add(buildLockController());
                break;
        }
        
        // æ·»åŠ ç«¯ç‚¹å¥åº·çŠ¶æ€
        capabilities.add(buildEndpointHealth());
        
        return capabilities;
    }
    
    private Capability buildModeController(String instance, List<String> modes) {
        return Capability.builder()
            .type("AlexaInterface")
            .interfaceName("Alexa.ModeController")
            .version("3")
            .instance(instance)
            .properties(Properties.builder()
                .supported(List.of(Property.of("mode")))
                .proactivelyReported(true)
                .retrievable(true)
                .build())
            .capabilityResources(CapabilityResources.builder()
                .friendlyNames(List.of(
                    FriendlyName.text("Mode", "en-US"),
                    FriendlyName.text("æ¨¡å¼", "zh-CN")
                ))
                .build())
            .configuration(Configuration.builder()
                .ordered(false)
                .supportedModes(modes.stream()
                    .map(this::buildMode)
                    .collect(Collectors.toList()))
                .build())
            .build();
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå®ç°çŠ¶æ€æŠ¥å‘Š**
```java
@Service
public class AlexaStateReporter {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Autowired
    private AlexaTokenService tokenService;
    
    private static final String EVENT_GATEWAY_URL = 
        "https://api.amazonalexa.com/v3/events";
    
    public void reportStateChange(Device device, DeviceState oldState, DeviceState newState) {
        try {
            // 1. è·å– Alexa Access Token
            String token = tokenService.getAlexaAccessToken(device.getUserId());
            
            // 2. æ„å»º ChangeReport
            AlexaChangeReport report = AlexaChangeReport.builder()
                .event(Event.builder()
                    .header(Header.builder()
                        .namespace("Alexa")
                        .name("ChangeReport")
                        .payloadVersion("3")
                        .messageId(UUID.randomUUID().toString())
                        .build())
                    .endpoint(Endpoint.builder()
                        .scope(Scope.bearerToken(token))
                        .endpointId(device.getDeviceId())
                        .build())
                    .payload(Payload.builder()
                        .change(Change.builder()
                            .cause(Cause.physicalInteraction())
                            .properties(buildChangedProperties(oldState, newState))
                            .build())
                        .build())
                    .build())
                .context(buildContext(newState))
                .build();
            
            // 3. å‘é€åˆ° Alexa Event Gateway
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.set("Authorization", "Bearer " + token);
            
            HttpEntity<AlexaChangeReport> request = new HttpEntity<>(report, headers);
            
            ResponseEntity<String> response = restTemplate.postForEntity(
                EVENT_GATEWAY_URL,
                request,
                String.class
            );
            
            if (response.getStatusCode().is2xxSuccessful()) {
                log.info("çŠ¶æ€æŠ¥å‘ŠæˆåŠŸ: deviceId={}", device.getDeviceId());
            } else {
                log.error("çŠ¶æ€æŠ¥å‘Šå¤±è´¥: deviceId={}, status={}", 
                    device.getDeviceId(), response.getStatusCode());
            }
            
        } catch (Exception e) {
            log.error("å‘é€çŠ¶æ€æŠ¥å‘Šå¼‚å¸¸", e);
        }
    }
    
    private List<Property> buildChangedProperties(DeviceState oldState, DeviceState newState) {
        List<Property> properties = new ArrayList<>();
        
        // æ£€æŸ¥ç”µæºçŠ¶æ€å˜åŒ–
        if (!oldState.getPowerState().equals(newState.getPowerState())) {
            properties.add(Property.builder()
                .namespace("Alexa.PowerController")
                .name("powerState")
                .value(newState.getPowerState())
                .timeOfSample(Instant.now())
                .uncertaintyInMilliseconds(500)
                .build());
        }
        
        // æ£€æŸ¥æ¨¡å¼å˜åŒ–
        if (!oldState.getWorkMode().equals(newState.getWorkMode())) {
            properties.add(Property.builder()
                .namespace("Alexa.ModeController")
                .instance("VacuumMode")
                .name("mode")
                .value(newState.getWorkMode())
                .timeOfSample(Instant.now())
                .uncertaintyInMilliseconds(500)
                .build());
        }
        
        return properties;
    }
}
```

**æ–¹æ¡ˆ 3ï¼šå®ç° AcceptGrant**
```java
@RestController
@RequestMapping("/alexa")
public class AlexaController {
    
    @PostMapping
    public ResponseEntity<?> handleDirective(@RequestBody AlexaRequest request) {
        String namespace = request.getDirective().getHeader().getNamespace();
        String name = request.getDirective().getHeader().getName();
        
        // å¤„ç† AcceptGrantï¼ˆå¯ç”¨ Skill æ—¶ï¼‰
        if ("Alexa.Authorization".equals(namespace) && "AcceptGrant".equals(name)) {
            return handleAcceptGrant(request);
        }
        
        // ... å…¶ä»–æŒ‡ä»¤å¤„ç†
    }
    
    private ResponseEntity<?> handleAcceptGrant(AlexaRequest request) {
        try {
            // 1. æå–æˆæƒç å’Œ grantee token
            Map<String, Object> payload = request.getDirective().getPayload();
            Map<String, String> grant = (Map<String, String>) payload.get("grant");
            
            String code = grant.get("code");
            Map<String, String> grantee = (Map<String, String>) payload.get("grantee");
            String granteeToken = grantee.get("token");
            
            // 2. ç”¨æˆæƒç æ¢å– Alexa Access Token
            AlexaToken alexaToken = alexaTokenService.exchangeToken(code);
            
            // 3. å­˜å‚¨ tokenï¼ˆç”¨äºåç»­çŠ¶æ€æŠ¥å‘Šï¼‰
            alexaTokenService.saveToken(granteeToken, alexaToken);
            
            // 4. è¿”å›æˆåŠŸå“åº”
            return ResponseEntity.ok(AlexaResponse.builder()
                .event(Event.builder()
                    .header(Header.builder()
                        .namespace("Alexa.Authorization")
                        .name("AcceptGrant.Response")
                        .payloadVersion("3")
                        .messageId(UUID.randomUUID().toString())
                        .build())
                    .payload(Map.of())
                    .build())
                .build());
            
        } catch (Exception e) {
            log.error("AcceptGrant å¤„ç†å¤±è´¥", e);
            return ResponseEntity.status(500).body(
                AlexaResponse.error("INTERNAL_ERROR", "å¤„ç†æˆæƒå¤±è´¥")
            );
        }
    }
}
```

### 4.5 Google Assistant ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- ç¼ºå°‘ Request Sync
- æ²¡æœ‰å®ç° Report State
- Local Fulfillment æœªå®ç°

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå®ç° Request Sync**
```java
@Service
public class GoogleSyncService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Autowired
    private GoogleServiceAccountService serviceAccountService;
    
    private static final String HOMEGRAPH_API_URL = 
        "https://homegraph.googleapis.com/v1/devices:requestSync";
    
    public void requestSync(Long userId) {
        try {
            // 1. è·å– Service Account Token
            String token = serviceAccountService.getAccessToken();
            
            // 2. è·å– agent_user_id
            String agentUserId = userService.getAgentUserId(userId);
            
            // 3. æ„å»ºè¯·æ±‚
            Map<String, String> request = Map.of(
                "agentUserId", agentUserId
            );
            
            // 4. å‘é€è¯·æ±‚
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.set("Authorization", "Bearer " + token);
            
            HttpEntity<Map<String, String>> entity = new HttpEntity<>(request, headers);
            
            ResponseEntity<String> response = restTemplate.postForEntity(
                HOMEGRAPH_API_URL,
                entity,
                String.class
            );
            
            if (response.getStatusCode().is2xxSuccessful()) {
                log.info("Request Sync æˆåŠŸ: userId={}", userId);
            } else {
                log.error("Request Sync å¤±è´¥: userId={}, status={}", 
                    userId, response.getStatusCode());
            }
            
        } catch (Exception e) {
            log.error("Request Sync å¼‚å¸¸", e);
        }
    }
    
    // åœ¨è®¾å¤‡å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘
    @EventListener
    public void onDeviceChanged(DeviceChangedEvent event) {
        requestSync(event.getUserId());
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå®ç° Report State**
```java
@Service
public class GoogleStateReporter {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Autowired
    private GoogleServiceAccountService serviceAccountService;
    
    private static final String REPORT_STATE_URL = 
        "https://homegraph.googleapis.com/v1/devices:reportStateAndNotification";
    
    public void reportState(Device device, DeviceState state) {
        try {
            // 1. è·å– Service Account Token
            String token = serviceAccountService.getAccessToken();
            
            // 2. è·å– agent_user_id
            String agentUserId = userService.getAgentUserId(device.getUserId());
            
            // 3. æ„å»ºçŠ¶æ€æ•°æ®
            Map<String, Object> stateData = Map.of(
                "requestId", UUID.randomUUID().toString(),
                "agentUserId", agentUserId,
                "payload", Map.of(
                    "devices", Map.of(
                        "states", Map.of(
                            device.getDeviceId(), buildDeviceState(state)
                        )
                    )
                )
            );
            
            // 4. å‘é€è¯·æ±‚
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.set("Authorization", "Bearer " + token);
            
            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(stateData, headers);
            
            ResponseEntity<String> response = restTemplate.postForEntity(
                REPORT_STATE_URL,
                entity,
                String.class
            );
            
            if (response.getStatusCode().is2xxSuccessful()) {
                log.info("Report State æˆåŠŸ: deviceId={}", device.getDeviceId());
            } else {
                log.error("Report State å¤±è´¥: deviceId={}, status={}", 
                    device.getDeviceId(), response.getStatusCode());
            }
            
        } catch (Exception e) {
            log.error("Report State å¼‚å¸¸", e);
        }
    }
    
    private Map<String, Object> buildDeviceState(DeviceState state) {
        Map<String, Object> stateMap = new HashMap<>();
        
        stateMap.put("online", state.isOnline());
        stateMap.put("on", "ON".equals(state.getPowerState()));
        
        if (state.getWorkMode() != null) {
            stateMap.put("currentModeSettings", Map.of(
                "mode", state.getWorkMode()
            ));
        }
        
        if (state.getBatteryLevel() != null) {
            stateMap.put("descriptiveCapacityRemaining", 
                state.getBatteryLevel() > 20 ? "FULL" : "LOW");
            stateMap.put("capacityRemaining", List.of(
                Map.of("rawValue", state.getBatteryLevel(), "unit", "PERCENTAGE")
            ));
        }
        
        return stateMap;
    }
}
```

**æ–¹æ¡ˆ 3ï¼šå‡†å¤‡ Local Fulfillment**
```javascript
// local-fulfillment/app.js
// ç”¨äº Google Local Fulfillment

const {smarthome} = require('actions-on-google');

const app = smarthome({
  debug: true,
});

app.onExecute(async (body, headers) => {
  const {requestId} = body;
  const {inputs} = body;
  
  const commands = [];
  
  for (const input of inputs) {
    for (const command of input.payload.commands) {
      for (const device of command.devices) {
        for (const execution of command.execution) {
          // é€šè¿‡æœ¬åœ°ç½‘ç»œå‘é€å‘½ä»¤åˆ° Home Assistant
          const result = await sendLocalCommand(
            device.id,
            execution.command,
            execution.params
          );
          
          commands.push({
            ids: [device.id],
            status: result.success ? 'SUCCESS' : 'ERROR',
            states: result.states
          });
        }
      }
    }
  }
  
  return {
    requestId: requestId,
    payload: {
      commands: commands
    }
  };
});

async function sendLocalCommand(deviceId, command, params) {
  // é€šè¿‡ mDNS å‘ç°æœ¬åœ° Home Assistant
  const haUrl = await discoverHomeAssistant();
  
  // å‘é€å‘½ä»¤
  const response = await fetch(`${haUrl}/api/device/${deviceId}/execute`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({command, params})
  });
  
  return await response.json();
}

exports.smarthome = app;
```

---

## 5. å®æ–½æ­¥éª¤

### é˜¶æ®µ 1ï¼šæ¶æ„é‡æ„ï¼ˆ2 å‘¨ï¼‰

#### ç¬¬ 1 å‘¨ï¼šæ ¸å¿ƒæŠ½è±¡å±‚

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»ºç»Ÿä¸€è®¾å¤‡æ¨¡å‹ï¼ˆSmartDevice æ¥å£ï¼‰
- [ ] åˆ›å»ºç»Ÿä¸€å‘½ä»¤æ¨¡å‹ï¼ˆDeviceCommand æ¥å£ï¼‰
- [ ] åˆ›å»ºèƒ½åŠ›æ˜ å°„å™¨ï¼ˆCapabilityMapperï¼‰
- [ ] åˆ›å»ºå¹³å°é€‚é…å™¨æ¥å£ï¼ˆPlatformAdapterï¼‰
- [ ] åˆ›å»ºè®¾å¤‡ç®¡ç†å™¨ï¼ˆDeviceManagerï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// Step 1.1: åˆ›å»ºç»Ÿä¸€è®¾å¤‡æ¨¡å‹
public interface SmartDevice {
    String getDeviceId();
    String getDeviceName();
    DeviceType getType();
    DeviceState getState();
    List<Capability> getCapabilities();
    boolean supportsCapability(String capability);
}

// Step 1.2: åˆ›å»ºç»Ÿä¸€å‘½ä»¤æ¨¡å‹
public interface DeviceCommand {
    String getCommandType();
    Map<String, Object> getParams();
    CommandResult execute(SmartDevice device);
}

// Step 1.3: åˆ›å»ºèƒ½åŠ›æ˜ å°„å™¨
@Component
public class CapabilityMapper {
    
    @Value("classpath:capability-mapping.yml")
    private Resource mappingResource;
    
    private Map<String, PlatformCapabilityMapping> mappings;
    
    @PostConstruct
    public void init() {
        // åŠ è½½æ˜ å°„é…ç½®
        mappings = loadMappings(mappingResource);
    }
    
    public List<Object> mapCapabilities(SmartDevice device, String platform) {
        PlatformCapabilityMapping mapping = mappings.get(device.getType().name());
        return mapping.getCapabilitiesForPlatform(platform);
    }
}
```

#### ç¬¬ 2 å‘¨ï¼šå¹³å°é€‚é…å™¨å®ç°

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç° AligenieAdapter
- [ ] å®ç° DuerOSAdapter
- [ ] å®ç° MiAIAdapter
- [ ] å®ç° AlexaAdapter
- [ ] å®ç° GoogleAdapter
- [ ] åˆ›å»ºå¹³å°æ³¨å†Œè¡¨ï¼ˆPlatformRegistryï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// Step 2.1: å®ç°å¹³å°é€‚é…å™¨
@Component
public class AligenieAdapter implements PlatformAdapter {
    
    @Autowired
    private CapabilityMapper capabilityMapper;
    
    @Autowired
    private DeviceManager deviceManager;
    
    @Override
    public String getPlatformName() {
        return "aligenie";
    }
    
    @Override
    public DiscoveryResponse handleDiscovery(DiscoveryRequest request) {
        List<SmartDevice> devices = deviceManager.getUserDevices(request.getUserId());
        
        List<AligenieDevice> aligenieDevices = devices.stream()
            .map(this::convertDevice)
            .collect(Collectors.toList());
        
        return new DiscoveryResponse(aligenieDevices);
    }
    
    private AligenieDevice convertDevice(SmartDevice device) {
        return AligenieDevice.builder()
            .deviceId(device.getDeviceId())
            .deviceName(device.getDeviceName())
            .deviceType(mapDeviceType(device.getType()))
            .properties(capabilityMapper.mapCapabilities(device, "aligenie"))
            .build();
    }
}

// Step 2.2: åˆ›å»ºå¹³å°æ³¨å†Œè¡¨
@Component
public class PlatformRegistry {
    
    private final Map<String, PlatformAdapter> adapters = new ConcurrentHashMap<>();
    
    public void register(PlatformAdapter adapter) {
        adapters.put(adapter.getPlatformName(), adapter);
    }
    
    public PlatformAdapter getAdapter(String platformName) {
        PlatformAdapter adapter = adapters.get(platformName);
        if (adapter == null) {
            throw new PlatformNotFoundException(platformName);
        }
        return adapter;
    }
    
    @PostConstruct
    public void init() {
        // è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰é€‚é…å™¨
        ApplicationContext context = applicationContext;
        Map<String, PlatformAdapter> beans = context.getBeansOfType(PlatformAdapter.class);
        beans.values().forEach(this::register);
    }
}
```

### é˜¶æ®µ 2ï¼šåŠŸèƒ½å¢å¼ºï¼ˆ2 å‘¨ï¼‰

#### ç¬¬ 3 å‘¨ï¼šçŠ¶æ€ç®¡ç†å’Œç¼“å­˜

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç° Redis ç¼“å­˜
- [ ] å®ç°çŠ¶æ€å˜åŒ–ç›‘å¬
- [ ] å®ç°çŠ¶æ€æŠ¥å‘ŠæœåŠ¡
- [ ] æ·»åŠ è®¾å¤‡åˆ†ç»„åŠŸèƒ½

#### ç¬¬ 4 å‘¨ï¼šé”™è¯¯å¤„ç†å’Œç›‘æ§

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- [ ] æ·»åŠ è¯·æ±‚è¿½è¸ªï¼ˆTrace IDï¼‰
- [ ] é›†æˆ Prometheus ç›‘æ§
- [ ] æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†

### é˜¶æ®µ 3ï¼šæµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ1 å‘¨ï¼‰

#### ç¬¬ 5 å‘¨ï¼šæµ‹è¯•å’Œæ–‡æ¡£

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æ›´æ–° API æ–‡æ¡£
- [ ] ç¼–å†™éƒ¨ç½²æ–‡æ¡£
- [ ] æ€§èƒ½æµ‹è¯•

---

## 6. ä»£ç ç¤ºä¾‹

### 6.1 ç»Ÿä¸€å…¥å£æ§åˆ¶å™¨

```java
@RestController
@RequestMapping("/api/platform")
public class PlatformDispatcherController {
    
    @Autowired
    private PlatformRegistry platformRegistry;
    
    @Autowired
    private OAuth2Service oauth2Service;
    
    @PostMapping("/{platform}/discovery")
    public ResponseEntity<?> handleDiscovery(
        @PathVariable String platform,
        @RequestHeader("Authorization") String authorization,
        @RequestBody Map<String, Object> request
    ) {
        // 1. éªŒè¯ token
        String token = extractToken(authorization);
        Long userId = oauth2Service.validateAndGetUserId(token);
        
        // 2. è·å–å¹³å°é€‚é…å™¨
        PlatformAdapter adapter = platformRegistry.getAdapter(platform);
        
        // 3. å¤„ç†è¯·æ±‚
        DiscoveryRequest discoveryRequest = new DiscoveryRequest(userId, request);
        DiscoveryResponse response = adapter.handleDiscovery(discoveryRequest);
        
        return ResponseEntity.ok(response.getData());
    }
    
    @PostMapping("/{platform}/control")
    public ResponseEntity<?> handleControl(
        @PathVariable String platform,
        @RequestHeader("Authorization") String authorization,
        @RequestBody Map<String, Object> request
    ) {
        // ç±»ä¼¼çš„å¤„ç†é€»è¾‘
    }
}
```

### 6.2 è®¾å¤‡ç®¡ç†å™¨

```java
@Service
public class DeviceManager {
    
    @Autowired
    private DeviceRepository deviceRepository;
    
    @Autowired
    private DeviceStateCache stateCache;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public List<SmartDevice> getUserDevices(Long userId) {
        return deviceRepository.findByUserId(userId).stream()
            .map(this::toSmartDevice)
            .collect(Collectors.toList());
    }
    
    public SmartDevice getDevice(String deviceId) {
        Device device = deviceRepository.findByDeviceId(deviceId)
            .orElseThrow(() -> new DeviceNotFoundException(deviceId));
        return toSmartDevice(device);
    }
    
    public void updateDeviceState(String deviceId, DeviceState newState) {
        Device device = deviceRepository.findByDeviceId(deviceId)
            .orElseThrow(() -> new DeviceNotFoundException(deviceId));
        
        DeviceState oldState = device.getState();
        device.setState(newState);
        deviceRepository.save(device);
        
        // æ›´æ–°ç¼“å­˜
        stateCache.cacheState(deviceId, newState);
        
        // å‘å¸ƒçŠ¶æ€å˜åŒ–äº‹ä»¶
        eventPublisher.publishEvent(new DeviceStateChangedEvent(
            this, device, oldState, newState
        ));
    }
    
    private SmartDevice toSmartDevice(Device device) {
        return new SmartDeviceImpl(device);
    }
}
```

### 6.3 å‘½ä»¤æ‰§è¡Œå™¨

```java
@Service
public class CommandExecutor {
    
    @Autowired
    private DeviceManager deviceManager;
    
    @Autowired
    private CommandFactory commandFactory;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public CommandResult execute(String deviceId, String commandType, Map<String, Object> params) {
        // 1. è·å–è®¾å¤‡
        SmartDevice device = deviceManager.getDevice(deviceId);
        
        // 2. åˆ›å»ºå‘½ä»¤
        DeviceCommand command = commandFactory.createCommand(commandType, params);
        
        // 3. éªŒè¯è®¾å¤‡æ˜¯å¦æ”¯æŒè¯¥å‘½ä»¤
        if (!device.supportsCapability(command.getCommandType())) {
            throw new UnsupportedCommandException(
                "è®¾å¤‡ä¸æ”¯æŒè¯¥å‘½ä»¤: " + command.getCommandType()
            );
        }
        
        // 4. æ‰§è¡Œå‘½ä»¤
        CommandResult result = command.execute(device);
        
        // 5. å‘å¸ƒå‘½ä»¤æ‰§è¡Œäº‹ä»¶
        eventPublisher.publishEvent(new CommandExecutedEvent(
            this, device, command, result
        ));
        
        return result;
    }
}
```

### 6.4 çŠ¶æ€å˜åŒ–ç›‘å¬å™¨

```java
@Component
public class StateChangeListener {
    
    @Autowired
    private AlexaStateReporter alexaReporter;
    
    @Autowired
    private GoogleStateReporter googleReporter;
    
    @Autowired
    private PlatformUserService platformUserService;
    
    @EventListener
    @Async
    public void onDeviceStateChanged(DeviceStateChangedEvent event) {
        Device device = event.getDevice();
        DeviceState oldState = event.getOldState();
        DeviceState newState = event.getNewState();
        
        // è·å–ç”¨æˆ·å¯ç”¨çš„å¹³å°
        List<String> enabledPlatforms = platformUserService
            .getEnabledPlatforms(device.getUserId());
        
        // å‘å„å¹³å°æŠ¥å‘ŠçŠ¶æ€
        for (String platform : enabledPlatforms) {
            try {
                switch (platform) {
                    case "alexa":
                        alexaReporter.reportStateChange(device, oldState, newState);
                        break;
                    case "google":
                        googleReporter.reportState(device, newState);
                        break;
                    // ä¸­å›½å¹³å°é€šå¸¸ä¸æ”¯æŒä¸»åŠ¨æ¨é€
                }
            } catch (Exception e) {
                log.error("å‘å¹³å° {} æŠ¥å‘ŠçŠ¶æ€å¤±è´¥", platform, e);
            }
        }
    }
}
```

### 6.5 èƒ½åŠ›æ˜ å°„é…ç½®

```yaml
# capability-mapping.yml
device_types:
  vacuum_cleaner:
    name: æ‰«åœ°æœºå™¨äºº
    
    # å¤©çŒ«ç²¾çµ
    aligenie:
      device_type: "CLEANING_ROBOT"
      actions:
        - name: "turnOn"
          capability: "power_control"
        - name: "turnOff"
          capability: "power_control"
        - name: "pause"
          capability: "pause_control"
        - name: "continue"
          capability: "pause_control"
        - name: "setMode"
          capability: "mode_control"
      properties:
        - name: "powerstate"
          type: "string"
          values: ["on", "off"]
        - name: "mode"
          type: "string"
          values: ["auto", "spot", "edge"]
    
    # å°åº¦éŸ³ç®±
    dueros:
      device_type: "CLEANING_ROBOT"
      actions:
        - "turnOn"
        - "turnOff"
        - "pause"
        - "continue"
        - "setMode"
      attributes:
        - name: "mode"
          values: ["auto", "spot", "edge"]
    
    # å°çˆ±åŒå­¦
    xiaomi:
      device_type: "vacuum-cleaner"
      properties:
        - name: "on"
          type: "boolean"
        - name: "mode"
          type: "integer"
          value_range: [0, 2]
          value_list:
            - value: 0
              description: "è‡ªåŠ¨"
            - value: 1
              description: "å®šç‚¹"
            - value: 2
              description: "æ²¿è¾¹"
    
    # Alexa
    alexa:
      display_category: "VACUUM_CLEANER"
      capabilities:
        - interface: "Alexa.PowerController"
          version: "3"
          properties:
            - name: "powerState"
        - interface: "Alexa.ModeController"
          version: "3"
          instance: "VacuumMode"
          configuration:
            ordered: false
            supported_modes:
              - value: "auto"
                friendly_names:
                  - text: "Auto"
                    locale: "en-US"
                  - text: "è‡ªåŠ¨"
                    locale: "zh-CN"
              - value: "spot"
                friendly_names:
                  - text: "Spot"
                    locale: "en-US"
                  - text: "å®šç‚¹"
                    locale: "zh-CN"
              - value: "edge"
                friendly_names:
                  - text: "Edge"
                    locale: "en-US"
                  - text: "æ²¿è¾¹"
                    locale: "zh-CN"
    
    # Google Assistant
    google:
      device_type: "action.devices.types.VACUUM"
      traits:
        - "action.devices.traits.OnOff"
        - "action.devices.traits.StartStop"
        - "action.devices.traits.Dock"
        - "action.devices.traits.Modes"
      attributes:
        available_modes:
          - name: "mode"
            name_values:
              - name_synonym: ["æ¨¡å¼", "mode"]
                lang: "zh"
            settings:
              - setting_name: "auto"
                setting_values:
                  - setting_synonym: ["è‡ªåŠ¨", "auto"]
                    lang: "zh"
              - setting_name: "spot"
                setting_values:
                  - setting_synonym: ["å®šç‚¹", "spot"]
                    lang: "zh"
              - setting_name: "edge"
                setting_values:
                  - setting_synonym: ["æ²¿è¾¹", "edge"]
                    lang: "zh"
            ordered: false

  light:
    name: ç¯å…‰
    
    aligenie:
      device_type: "LIGHT"
      actions:
        - "turnOn"
        - "turnOff"
        - "setBrightness"
        - "setColor"
    
    dueros:
      device_type: "LIGHT"
      actions:
        - "turnOn"
        - "turnOff"
        - "setBrightness"
        - "setColor"
    
    xiaomi:
      device_type: "light"
      properties:
        - name: "on"
          type: "boolean"
        - name: "brightness"
          type: "integer"
          value_range: [0, 100]
        - name: "color"
          type: "integer"
    
    alexa:
      display_category: "LIGHT"
      capabilities:
        - interface: "Alexa.PowerController"
        - interface: "Alexa.BrightnessController"
        - interface: "Alexa.ColorController"
        - interface: "Alexa.ColorTemperatureController"
    
    google:
      device_type: "action.devices.types.LIGHT"
      traits:
        - "action.devices.traits.OnOff"
        - "action.devices.traits.Brightness"
        - "action.devices.traits.ColorSetting"
      attributes:
        color_model: "rgb"
        color_temperature_range:
          temperature_min_k: 2000
          temperature_max_k: 9000
```

---

## 7. æµ‹è¯•æ–¹æ¡ˆ

### 7.1 å•å…ƒæµ‹è¯•

```java
@SpringBootTest
public class DeviceManagerTest {
    
    @Autowired
    private DeviceManager deviceManager;
    
    @MockBean
    private DeviceRepository deviceRepository;
    
    @Test
    public void testGetUserDevices() {
        // Given
        Long userId = 1L;
        List<Device> mockDevices = Arrays.asList(
            createMockDevice("robot_001", "æ‰«åœ°æœºå™¨äºº"),
            createMockDevice("light_001", "å®¢å…ç¯")
        );
        when(deviceRepository.findByUserId(userId)).thenReturn(mockDevices);
        
        // When
        List<SmartDevice> devices = deviceManager.getUserDevices(userId);
        
        // Then
        assertEquals(2, devices.size());
        assertEquals("robot_001", devices.get(0).getDeviceId());
    }
    
    @Test
    public void testUpdateDeviceState() {
        // Given
        String deviceId = "robot_001";
        Device mockDevice = createMockDevice(deviceId, "æ‰«åœ°æœºå™¨äºº");
        when(deviceRepository.findByDeviceId(deviceId))
            .thenReturn(Optional.of(mockDevice));
        
        DeviceState newState = DeviceState.builder()
            .powerState("ON")
            .workMode("auto")
            .build();
        
        // When
        deviceManager.updateDeviceState(deviceId, newState);
        
        // Then
        verify(deviceRepository).save(mockDevice);
        assertEquals("ON", mockDevice.getPowerState());
    }
}
```

### 7.2 é›†æˆæµ‹è¯•

```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
public class AligenieIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private OAuth2Service oauth2Service;
    
    private String accessToken;
    
    @BeforeEach
    public void setup() {
        // è·å–æµ‹è¯• token
        accessToken = oauth2Service.generateTestToken(1L);
    }
    
    @Test
    public void testFullAligenieFlow() throws Exception {
        // 1. æµ‹è¯•è®¾å¤‡å‘ç°
        mockMvc.perform(post("/aligenie/discovery")
            .header("Authorization", "Bearer " + accessToken)
            .contentType(MediaType.APPLICATION_JSON)
            .content(readFile("aligenie-discovery-request.json")))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.header.namespace").value("AliGenie.Iot.Device.Discovery"))
            .andExpect(jsonPath("$.payload.devices").isArray())
            .andExpect(jsonPath("$.payload.devices[0].deviceId").value("robot_001"));
        
        // 2. æµ‹è¯•è®¾å¤‡æ§åˆ¶
        mockMvc.perform(post("/aligenie/control")
            .header("Authorization", "Bearer " + accessToken)
            .contentType(MediaType.APPLICATION_JSON)
            .content(readFile("aligenie-turnon-request.json")))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.header.name").value("TurnOnResponse"));
        
        // 3. éªŒè¯è®¾å¤‡çŠ¶æ€å·²æ›´æ–°
        mockMvc.perform(post("/aligenie/query")
            .header("Authorization", "Bearer " + accessToken)
            .contentType(MediaType.APPLICATION_JSON)
            .content(readFile("aligenie-query-request.json")))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.payload.properties[0].value").value("on"));
    }
}
```

### 7.3 æ€§èƒ½æµ‹è¯•

```java
@SpringBootTest
public class PerformanceTest {
    
    @Autowired
    private DeviceManager deviceManager;
    
    @Test
    public void testConcurrentDeviceControl() throws InterruptedException {
        int threadCount = 100;
        int requestsPerThread = 10;
        
        ExecutorService executor = Executors.newFixedThreadPool(threadCount);
        CountDownLatch latch = new CountDownLatch(threadCount);
        
        AtomicInteger successCount = new AtomicInteger(0);
        AtomicInteger failureCount = new AtomicInteger(0);
        
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < threadCount; i++) {
            executor.submit(() -> {
                try {
                    for (int j = 0; j < requestsPerThread; j++) {
                        deviceManager.updateDeviceState(
                            "robot_001",
                            DeviceState.builder().powerState("ON").build()
                        );
                        successCount.incrementAndGet();
                    }
                } catch (Exception e) {
                    failureCount.incrementAndGet();
                } finally {
                    latch.countDown();
                }
            });
        }
        
        latch.await();
        executor.shutdown();
        
        long endTime = System.currentTimeMillis();
        long duration = endTime - startTime;
        
        int totalRequests = threadCount * requestsPerThread;
        double qps = (totalRequests * 1000.0) / duration;
        
        System.out.println("æ€»è¯·æ±‚æ•°: " + totalRequests);
        System.out.println("æˆåŠŸ: " + successCount.get());
        System.out.println("å¤±è´¥: " + failureCount.get());
        System.out.println("è€—æ—¶: " + duration + "ms");
        System.out.println("QPS: " + qps);
        
        assertTrue(successCount.get() > totalRequests * 0.95); // 95% æˆåŠŸç‡
        assertTrue(qps > 1000); // QPS > 1000
    }
}
```

---

## 8. éƒ¨ç½²æ–¹æ¡ˆ

### 8.1 Docker Compose éƒ¨ç½²ï¼ˆå·²æœ‰ï¼‰

ä¿æŒç°æœ‰çš„ Docker Compose é…ç½®ï¼Œæ·»åŠ  Redisï¼š

```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    # ... ç°æœ‰é…ç½®
  
  redis:
    image: redis:7-alpine
    container_name: voice-platform-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - voice-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  app:
    build:
      context: .
      dockerfile: Dockerfile
    # ... ç°æœ‰é…ç½®
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # ... ç°æœ‰ç¯å¢ƒå˜é‡
      REDIS_HOST: redis
      REDIS_PORT: 6379

volumes:
  mysql-data:
  redis-data:
  app-logs:

networks:
  voice-network:
```

### 8.2 Kubernetes éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

```yaml
# k8s/deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: voice-platform
spec:
  replicas: 3
  selector:
    matchLabels:
      app: voice-platform
  template:
    metadata:
      labels:
        app: voice-platform
    spec:
      containers:
      - name: voice-platform
        image: voice-platform:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: DB_HOST
          value: "mysql-service"
        - name: REDIS_HOST
          value: "redis-service"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
```

---

## 9. ç›‘æ§å’Œå‘Šè­¦

### 9.1 Prometheus ç›‘æ§

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'voice-platform'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8080']
```

### 9.2 Grafana ä»ªè¡¨æ¿

åˆ›å»ºç›‘æ§æŒ‡æ ‡ï¼š
- è¯·æ±‚ QPS
- å“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰
- é”™è¯¯ç‡
- è®¾å¤‡åœ¨çº¿ç‡
- å¹³å°è¯·æ±‚åˆ†å¸ƒ

### 9.3 å‘Šè­¦è§„åˆ™

```yaml
# alert-rules.yml
groups:
  - name: voice-platform
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "é”™è¯¯ç‡è¿‡é«˜"
          description: "5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡ 5%"
      
      - alert: SlowResponse
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å“åº”æ—¶é—´è¿‡æ…¢"
          description: "P95 å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’"
```

---

## 10. æ€»ç»“

### 10.1 ä¼˜åŒ–æ”¶ç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ä»£ç å¤ç”¨ç‡ | 80% | 90%+ | +10% |
| æ–°å¢å¹³å°æ—¶é—´ | 2 å¤© | 4 å°æ—¶ | -75% |
| å“åº”æ—¶é—´ P95 | 500ms | <200ms | -60% |
| æµ‹è¯•è¦†ç›–ç‡ | 20% | 80%+ | +60% |
| å¯ç»´æŠ¤æ€§ | ä¸­ | é«˜ | â†‘â†‘ |

### 10.2 å…³é”®æ”¹è¿›

1. âœ… **ç»Ÿä¸€æŠ½è±¡å±‚**ï¼šè®¾å¤‡ã€å‘½ä»¤ã€èƒ½åŠ›ç»Ÿä¸€å»ºæ¨¡
2. âœ… **æ’ä»¶åŒ–æ¶æ„**ï¼šå¹³å°é€‚é…å™¨å¯æ’æ‹”
3. âœ… **é…ç½®é©±åŠ¨**ï¼šèƒ½åŠ›æ˜ å°„é…ç½®åŒ–
4. âœ… **å®Œå–„æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + æ€§èƒ½æµ‹è¯•
5. âœ… **å¢å¼ºç›‘æ§**ï¼šPrometheus + Grafana + å‘Šè­¦

### 10.3 åç»­è§„åˆ’

1. **Phase 1**ï¼ˆå·²å®Œæˆï¼‰ï¼šäº”å¤§å¹³å°åŸºç¡€å¯¹æ¥
2. **Phase 2**ï¼ˆå½“å‰ï¼‰ï¼šæ¶æ„ä¼˜åŒ–å’ŒåŠŸèƒ½å¢å¼º
3. **Phase 3**ï¼ˆæœªæ¥ï¼‰ï¼š
   - æ”¯æŒæ›´å¤šè®¾å¤‡ç±»å‹
   - å®ç°åœºæ™¯è”åŠ¨
   - æ”¯æŒ Matter åè®®
   - AI è¯­éŸ³å¢å¼º

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**æ›´æ–°æ—¶é—´**ï¼š2026-02-25  
**é€‚ç”¨é¡¹ç›®**ï¼šå¤šå¹³å°æ™ºèƒ½éŸ³ç®±å¯¹æ¥é¡¹ç›®
