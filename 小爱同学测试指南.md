# å°çˆ±åŒå­¦æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•å‡†å¤‡

### 1. ç¯å¢ƒå‡†å¤‡
- âœ… åº”ç”¨å·²å¯åŠ¨ï¼ˆç«¯å£ 8080ï¼‰
- âœ… æ•°æ®åº“å·²é…ç½®
- âœ… å°çˆ±å®¢æˆ·ç«¯å·²æ·»åŠ åˆ°æ•°æ®åº“

### 2. æ·»åŠ å°çˆ±å®¢æˆ·ç«¯

```sql
INSERT INTO oauth_clients (client_id, client_secret, redirect_uri, user_id) 
VALUES ('miai_client_id', 'miai_client_secret', 'https://xiaoai.mi.com/callback', 1)
ON DUPLICATE KEY UPDATE client_secret='miai_client_secret';
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: OAuth æˆæƒæµ‹è¯•

#### 1.1 è®¿é—®æˆæƒé¡µé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
http://localhost:8080/authorize?client_id=miai_client_id&redirect_uri=https://xiaoai.mi.com/callback&state=test123&response_type=code
```

#### 1.2 ç‚¹å‡»æˆæƒ

ç‚¹å‡»"æˆæƒ"æŒ‰é’®åï¼Œä¼šé‡å®šå‘åˆ°ï¼š
```
https://xiaoai.mi.com/callback?code=XXXXXX&state=test123
```

è®°å½•ä¸‹ `code` å‚æ•°çš„å€¼ã€‚

#### 1.3 è·å– Access Token

```bash
curl -X POST "http://localhost:8080/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code" \
  -d "client_id=miai_client_id" \
  -d "client_secret=miai_client_secret" \
  -d "code=YOUR_CODE_HERE"
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "access_token": "abc123xyz...",
  "token_type": "Bearer",
  "expires_in": 259200,
  "refresh_token": "refresh_abc123..."
}
```

è®°å½•ä¸‹ `access_token` çš„å€¼ã€‚

### æ­¥éª¤ 2: å¥åº·æ£€æŸ¥æµ‹è¯•

```bash
curl -X GET "http://localhost:8080/miai/health"
```

é¢„æœŸå“åº”ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": "ok",
    "platform": "xiaomi-miai",
    "timestamp": 1708761234567
  }
}
```

### æ­¥éª¤ 3: è®¾å¤‡å‘ç°æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/discovery" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

é¢„æœŸå“åº”ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "devices": [
      {
        "device_id": "robot_001",
        "device_name": "å®¢å…æ‰«åœ°æœºå™¨äºº",
        "device_type": "vacuum-cleaner",
        "online": true,
        "room": "å®¢å…",
        "properties": {
          "power_state": "off",
          "work_mode": "auto",
          "battery_level": 85
        },
        "actions": ["turn-on", "turn-off", "pause", "continue", "set-mode", "query"]
      }
    ],
    "count": 1
  }
}
```

### æ­¥éª¤ 4: è®¾å¤‡æ§åˆ¶æµ‹è¯•

#### 4.1 å¼€æœºæµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "turn-on",
    "deviceId": "robot_001",
    "requestId": "test-control-001"
  }'
```

é¢„æœŸå“åº”ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

#### 4.2 å…³æœºæµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "turn-off",
    "deviceId": "robot_001",
    "requestId": "test-control-002"
  }'
```

#### 4.3 æš‚åœæµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "pause",
    "deviceId": "robot_001",
    "requestId": "test-control-003"
  }'
```

#### 4.4 ç»§ç»­æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "continue",
    "deviceId": "robot_001",
    "requestId": "test-control-004"
  }'
```

#### 4.5 è®¾ç½®æ¨¡å¼æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/control" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "set-mode",
    "deviceId": "robot_001",
    "requestId": "test-control-005",
    "params": {
      "mode": "spot"
    }
  }'
```

### æ­¥éª¤ 5: è®¾å¤‡æŸ¥è¯¢æµ‹è¯•

```bash
curl -X POST "http://localhost:8080/miai/query" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "robot_001",
    "requestId": "test-query-001"
  }'
```

é¢„æœŸå“åº”ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": {
      "device_id": "robot_001",
      "device_name": "å®¢å…æ‰«åœ°æœºå™¨äºº",
      "power_state": "on",
      "work_mode": "spot",
      "battery_level": 85,
      "status": "online",
      "online": true
    }
  }
}
```

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### OAuth æˆæƒ
- [ ] æˆæƒé¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] ç‚¹å‡»æˆæƒåæ­£å¸¸è·³è½¬
- [ ] æˆåŠŸè·å–æˆæƒç 
- [ ] æˆåŠŸæ¢å– access_token
- [ ] Token åŒ…å«æ­£ç¡®çš„å­—æ®µ

### å¥åº·æ£€æŸ¥
- [ ] å¥åº·æ£€æŸ¥æ¥å£è¿”å›æ­£å¸¸
- [ ] è¿”å›å¹³å°æ ‡è¯†æ­£ç¡®

### è®¾å¤‡å‘ç°
- [ ] è¯·æ±‚æˆåŠŸè¿”å› 200
- [ ] è¿”å›è®¾å¤‡åˆ—è¡¨
- [ ] è®¾å¤‡ä¿¡æ¯å®Œæ•´
- [ ] è®¾å¤‡ç±»å‹ä¸º vacuum-cleaner
- [ ] æ”¯æŒçš„æ“ä½œåˆ—è¡¨æ­£ç¡®

### è®¾å¤‡æ§åˆ¶
- [ ] å¼€æœºå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] å…³æœºå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] æš‚åœå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] ç»§ç»­å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] è®¾ç½®æ¨¡å¼å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- [ ] æ•°æ®åº“ä¸­è®¾å¤‡çŠ¶æ€å·²æ›´æ–°

### è®¾å¤‡æŸ¥è¯¢
- [ ] æŸ¥è¯¢è®¾å¤‡çŠ¶æ€æˆåŠŸ
- [ ] è¿”å›çš„çŠ¶æ€ä¿¡æ¯å®Œæ•´
- [ ] ç”µé‡ä¿¡æ¯æ­£ç¡®

### é”™è¯¯å¤„ç†
- [ ] æ— æ•ˆ Token è¿”å› 401
- [ ] è®¾å¤‡ä¸å­˜åœ¨è¿”å› 404
- [ ] ä¸æ”¯æŒçš„æ“ä½œè¿”å› 400
- [ ] é”™è¯¯ä¿¡æ¯æ ¼å¼æ­£ç¡®

## ğŸ” æ—¥å¿—æ£€æŸ¥

å¯åŠ¨åº”ç”¨åï¼ŒæŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š

```
å°çˆ±è®¾å¤‡å‘ç°è¯·æ±‚
å°çˆ±è®¾å¤‡å‘ç°å®Œæˆ: userId=1, deviceCount=1
å°çˆ±è®¾å¤‡æ§åˆ¶è¯·æ±‚: intent=turn-on, deviceId=robot_001, requestId=test-control-001
å°çˆ±è®¾å¤‡å¼€æœº: deviceId=robot_001, deviceName=å®¢å…æ‰«åœ°æœºå™¨äºº
å°çˆ±è®¾å¤‡æŸ¥è¯¢è¯·æ±‚: deviceId=robot_001, requestId=test-query-001
å°çˆ±è®¾å¤‡æŸ¥è¯¢å®Œæˆ: deviceId=robot_001, powerState=on, batteryLevel=85
```

## ğŸ“Š ä¸‰å¹³å°å¯¹æ¯”æµ‹è¯•

### è¯·æ±‚æ ¼å¼å¯¹æ¯”

**å¤©çŒ«ç²¾çµ**:
```json
{
  "header": {"namespace": "AliGenie.Iot.Device.Control", "name": "TurnOn"},
  "payload": {"deviceId": "robot_001"}
}
```

**å°åº¦éŸ³ç®±**:
```json
{
  "header": {"namespace": "DuerOS.ConnectedHome.Control", "name": "TurnOnRequest"},
  "payload": {"appliance": {"applianceId": "robot_001"}}
}
```

**å°çˆ±åŒå­¦** (æœ€ç®€æ´):
```json
{
  "intent": "turn-on",
  "deviceId": "robot_001",
  "requestId": "test-001"
}
```

### å“åº”æ ¼å¼å¯¹æ¯”

**å¤©çŒ«ç²¾çµ/å°åº¦**:
```json
{
  "header": {...},
  "payload": {...}
}
```

**å°çˆ±åŒå­¦** (æœ€ç®€æ´):
```json
{
  "code": 0,
  "message": "success",
  "data": {...}
}
```

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Token éªŒè¯å¤±è´¥

**ç°è±¡**: è¿”å› 401 Unauthorized

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
3. æ£€æŸ¥ Authorization header æ ¼å¼

### é—®é¢˜ 2: è®¾å¤‡ä¸å­˜åœ¨

**ç°è±¡**: è¿”å› code=404

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥è®¾å¤‡ ID æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥è®¾å¤‡
3. æ£€æŸ¥ç”¨æˆ· ID æ˜¯å¦åŒ¹é…

### é—®é¢˜ 3: ä¸æ”¯æŒçš„æ“ä½œ

**ç°è±¡**: è¿”å› code=400

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ intent åç§°æ˜¯å¦æ­£ç¡®ï¼ˆä½¿ç”¨å°å†™+è¿å­—ç¬¦ï¼‰
2. æŸ¥çœ‹æ”¯æŒçš„æ“ä½œåˆ—è¡¨
3. æ£€æŸ¥è¯·æ±‚æ ¼å¼æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 4: ç¼ºå°‘å‚æ•°

**ç°è±¡**: è¿”å› "ç¼ºå°‘å¿…è¦å‚æ•°"

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ intent å’Œ deviceId æ˜¯å¦éƒ½æä¾›
2. è®¾ç½®æ¨¡å¼æ—¶æ£€æŸ¥ params.mode æ˜¯å¦æä¾›
3. æŸ¥è¯¢æ—¶æ£€æŸ¥ deviceId æ˜¯å¦æä¾›

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

### å“åº”æ—¶é—´è¦æ±‚
- OAuth æˆæƒ: < 1ç§’
- Token è·å–: < 500ms
- è®¾å¤‡å‘ç°: < 1ç§’
- è®¾å¤‡æ§åˆ¶: < 300ms
- è®¾å¤‡æŸ¥è¯¢: < 300ms

### å¹¶å‘æµ‹è¯•

ä½¿ç”¨ Apache Bench è¿›è¡Œå¹¶å‘æµ‹è¯•ï¼š

```bash
# æµ‹è¯•è®¾å¤‡æ§åˆ¶æ¥å£
ab -n 100 -c 10 -H "Authorization: Bearer YOUR_TOKEN" \
   -p control.json -T application/json \
   http://localhost:8080/miai/control
```

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼š

1. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
2. é…ç½®å°ç±³ IoT å¼€æ”¾å¹³å°
3. åœ¨å°çˆ± App ä¸­æµ‹è¯•
4. è¿›è¡Œè¯­éŸ³æ§åˆ¶æµ‹è¯•
5. æäº¤å®¡æ ¸

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```
æµ‹è¯•æ—¥æœŸ: 2026-02-24
æµ‹è¯•äººå‘˜: XXX
æµ‹è¯•ç¯å¢ƒ: æœ¬åœ°å¼€å‘ç¯å¢ƒ
æµ‹è¯•å¹³å°: å°çˆ±åŒå­¦

æµ‹è¯•ç»“æœ:
âœ… OAuth æˆæƒæµç¨‹: é€šè¿‡
âœ… å¥åº·æ£€æŸ¥: é€šè¿‡
âœ… è®¾å¤‡å‘ç°åŠŸèƒ½: é€šè¿‡
âœ… è®¾å¤‡æ§åˆ¶åŠŸèƒ½: é€šè¿‡
âœ… è®¾å¤‡æŸ¥è¯¢åŠŸèƒ½: é€šè¿‡
âœ… é”™è¯¯å¤„ç†: é€šè¿‡

æ€§èƒ½æŒ‡æ ‡:
- å¹³å‡å“åº”æ—¶é—´: 150ms
- å¹¶å‘æ”¯æŒ: 10 QPS
- æˆåŠŸç‡: 100%

ç‰¹ç‚¹:
- è¯·æ±‚æ ¼å¼æœ€ç®€æ´
- å“åº”æ ¼å¼æœ€ç®€å•
- æ˜“äºç†è§£å’Œä½¿ç”¨

é—®é¢˜è®°å½•:
æ— 

ç»“è®º: æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

å¯¹æ¯”å…¶ä»–å¹³å°:
- æ¯”å¤©çŒ«ç²¾çµç®€æ´ 40%
- æ¯”å°åº¦éŸ³ç®±ç®€æ´ 50%
- å¼€å‘æ•ˆç‡æœ€é«˜
```

## ğŸ‰ æ€»ç»“

å°çˆ±åŒå­¦çš„æµ‹è¯•ç‰¹ç‚¹ï¼š

1. **è¯·æ±‚æœ€ç®€æ´**: æ‰å¹³çš„ JSON ç»“æ„
2. **å“åº”æœ€ç®€å•**: code + message + data
3. **æ˜“äºæµ‹è¯•**: å‚æ•°å°‘ï¼Œæ ¼å¼ç®€å•
4. **å¼€å‘å‹å¥½**: å‘½åç›´è§‚ï¼Œæ˜“äºç†è§£

ç°åœ¨å·²ç»å®Œæˆäº†ä¸‰ä¸ªå¹³å°çš„å¯¹æ¥ï¼š
- âœ… å¤©çŒ«ç²¾çµ
- âœ… å°åº¦éŸ³ç®±
- âœ… å°çˆ±åŒå­¦

ä¸€å¥—åç«¯ï¼Œæ”¯æŒä¸‰å¤§ä¸»æµè¯­éŸ³å¹³å°ï¼ğŸ‰
