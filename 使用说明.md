# 多平台智能音箱对接项目使用说明

## 📖 项目介绍

本项目是一个完整的多平台智能音箱对接解决方案，支持：
- ✅ 天猫精灵（AliGenie）
- ✅ 小度音箱（DuerOS）
- ✅ 小爱同学（MiAI）

一套后端代码，同时支持三大主流平台，市场覆盖率达 75%+。

## 🚀 快速开始

### 第一步：环境准备

确保你的电脑已安装：
- JDK 1.8 或更高版本
- MySQL 8.0 或更高版本
- Maven 3.6 或更高版本

### 第二步：创建数据库和导入测试数据

#### 方式一：使用配置脚本（推荐）

**Windows 用户**：
```bash
# 1. 编辑配置脚本，填写平台配置
# 右键编辑 配置替换脚本.bat

# 2. 运行脚本
配置替换脚本.bat

# 3. 按提示输入 MySQL 配置并导入数据
```

**Linux/Mac 用户**：
```bash
# 1. 编辑配置脚本，填写平台配置
vim 配置替换脚本.sh

# 2. 运行脚本
bash 配置替换脚本.sh

# 3. 按提示输入 MySQL 配置并导入数据
```

#### 方式二：手动配置

```bash
# 1. 创建数据库
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS smarthomedb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 2. 导入表结构
mysql -u root -p smarthomedb < src/main/resources/smarthomedb.sql

# 3. 编辑测试数据文件
# 将 smarthomedb.sql 中的 YOUR_ALIGENIE_CLIENT_ID 等占位符替换为实际值

# 4. 导入测试数据
mysql -u root -p smarthomedb < src/main/resources/smarthomedb.sql
```

#### 测试数据说明

导入后会包含以下测试数据：
- **3 个平台的 OAuth 客户端**（天猫精灵、小度音箱、小爱同学）
- **3 个测试用户**（testuser、zhangsan、lisi）
- **7 台扫地机器人设备**（不同状态和场景）

详细配置说明请查看：[平台配置说明.md](平台配置说明.md)

### 第三步：修改配置

编辑 `src/main/resources/application.yml`，修改数据库密码：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/smarthomedb?useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: YOUR_PASSWORD_HERE  # 修改为你的 MySQL 密码
```

### 第四步：启动项目

#### 方式一：使用 Maven 启动
```bash
mvn spring-boot:run
```

#### 方式二：使用脚本启动

Windows:
```bash
start.bat
```

Linux/Mac:
```bash
./start.sh
```

#### 方式三：打包后启动
```bash
# 打包
mvn clean package

# 运行
java -jar target/aligenie-smarthome-1.0.0.jar
```

### 第五步：验证启动

看到以下信息表示启动成功：
```
========================================
多平台智能音箱服务启动成功！
支持平台：天猫精灵、小度音箱、小爱同学
========================================
```

访问 http://localhost:8080 确认服务正常运行。

## 🧪 测试接口

### 方式一：使用 Postman

1. 导入 `postman_collection.json` 到 Postman
2. 按照集合中的顺序测试接口：
   - 0. OAuth 授权
   - 1. 天猫精灵接口
   - 2. 小度音箱接口
   - 3. 小爱同学接口

### 方式二：使用浏览器测试 OAuth

访问授权页面：
```
http://localhost:8080/authorize?client_id=test_client_id&redirect_uri=http://localhost:8080/callback&state=test&response_type=code
```

点击"授权"按钮，从重定向 URL 中获取 code。

### 方式三：使用 curl 测试

```bash
# 1. 获取 access_token（先通过浏览器获取 code）
curl -X POST http://localhost:8080/token \
  -d "grant_type=authorization_code" \
  -d "client_id=test_client_id" \
  -d "client_secret=test_client_secret" \
  -d "code=YOUR_CODE_HERE"

# 2. 测试天猫精灵设备发现
curl -X POST http://localhost:8080/smarthome/discovery \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Discovery",
      "name": "DiscoveryRequest",
      "messageId": "test-001",
      "payloadVersion": "1"
    },
    "payload": {}
  }'

# 3. 测试小度音箱设备发现
curl -X POST http://localhost:8080/dueros/discovery \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "namespace": "DuerOS.ConnectedHome.Discovery",
      "name": "DiscoverAppliancesRequest",
      "messageId": "test-002",
      "payloadVersion": "1.0"
    },
    "payload": {
      "accessToken": "YOUR_ACCESS_TOKEN"
    }
  }'

# 4. 测试小爱同学设备发现
curl -X POST http://localhost:8080/miai/discovery \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{}'
```

## 📚 接口说明

### OAuth 接口（三平台共用）

| 接口 | 方法 | 说明 |
|------|------|------|
| /authorize | GET | 授权页面 |
| /token | POST | 获取/刷新令牌 |

### 天猫精灵接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /smarthome/discovery | POST | 设备发现 |
| /smarthome/control | POST | 设备控制 |
| /smarthome/query | POST | 设备查询 |

### 小度音箱接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /dueros/discovery | POST | 设备发现 |
| /dueros/control | POST | 设备控制 |

### 小爱同学接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /miai/discovery | POST | 设备发现 |
| /miai/control | POST | 设备控制 |
| /miai/query | POST | 设备查询 |
| /miai/health | GET | 健康检查 |

## 🎮 语音控制

### 配置步骤

1. 在对应平台的开放平台创建技能
2. 配置 OAuth 地址：`https://your-domain.com/authorize`
3. 配置 Webhook 地址：
   - 天猫精灵：`https://your-domain.com/smarthome/*`
   - 小度音箱：`https://your-domain.com/dueros/*`
   - 小爱同学：`https://your-domain.com/miai/*`
4. 在 App 中添加技能并授权
5. 开始语音控制

### 语音命令示例

**天猫精灵**：
- "天猫精灵，打开扫地机器人"
- "天猫精灵，关闭扫地机器人"
- "天猫精灵，暂停扫地机器人"

**小度音箱**：
- "小度小度，打开扫地机器人"
- "小度小度，关闭扫地机器人"
- "小度小度，暂停扫地机器人"

**小爱同学**：
- "小爱同学，打开扫地机器人"
- "小爱同学，关闭扫地机器人"
- "小爱同学，暂停扫地机器人"

## 📖 文档导航

### 新手入门
1. [README.md](README.md) - 项目说明
2. [QUICKSTART.md](QUICKSTART.md) - 快速开始
3. [项目总览.md](项目总览.md) - 项目总览
4. [使用说明.md](使用说明.md) - 本文档

### 技术文档
1. [API.md](API.md) - API 接口文档
2. [ARCHITECTURE.md](ARCHITECTURE.md) - 架构设计
3. [DEPLOYMENT.md](DEPLOYMENT.md) - 部署指南

### 平台对接
1. [三平台对接完整方案.md](三平台对接完整方案.md) - 三平台对比
2. [小度音箱对接方案.md](小度音箱对接方案.md) - 小度详细方案
3. [小爱同学对接方案.md](小爱同学对接方案.md) - 小爱详细方案
4. [多平台对接方案对比.md](多平台对接方案对比.md) - 平台差异

### 测试指南
1. [小度音箱测试指南.md](小度音箱测试指南.md)
2. [小爱同学测试指南.md](小爱同学测试指南.md)

## ❓ 常见问题

### 1. 启动失败：端口被占用

**问题**：`Port 8080 was already in use`

**解决**：
- 方式一：修改 `application.yml` 中的端口号
- 方式二：关闭占用 8080 端口的程序

### 2. 数据库连接失败

**问题**：`Communications link failure`

**解决**：
1. 确认 MySQL 服务已启动
2. 检查数据库用户名和密码
3. 确认数据库已创建

### 3. 编译失败：找不到符号

**问题**：编译时报错找不到 getter/setter 方法

**解决**：
这是 IDE 的诊断信息，实际上项目使用了 Lombok 自动生成这些方法。
使用 Maven 编译是正常的：
```bash
mvn clean compile
```

### 4. Token 验证失败

**问题**：接口返回 `INVALID_TOKEN`

**解决**：
1. 确认已通过 OAuth 流程获取 token
2. 检查 token 是否过期（默认 7200 秒）
3. 确认 Authorization header 格式：`Bearer YOUR_TOKEN`

### 5. 设备列表为空

**问题**：设备发现接口返回空列表

**解决**：
检查数据库中是否有设备数据：
```sql
SELECT * FROM devices WHERE user_id = 1;
```

如果没有，执行 `smarthomedb.sql` 中的示例数据插入语句。

## 🔧 开发建议

### 添加新设备类型

1. 在 `Device` 实体类中添加新字段（如需要）
2. 在 `DeviceService` 中添加新的控制方法
3. 在各平台 Controller 中添加新的 action 分支
4. 更新数据库表结构

### 添加新平台

1. 创建平台专用 Controller（参考现有 Controller）
2. 创建平台专用 DTO（Request 和 Response）
3. 复用 OAuthService 和 DeviceService
4. 添加路由映射（如 `/newplatform/*`）
5. 预计开发时间：3-4 小时

### 集成真实设备

修改 `DeviceService` 中的方法，调用真实设备的 API：

```java
public Device turnOn(String deviceId) {
    Device device = deviceRepository.findByDeviceId(deviceId).orElse(null);
    if (device != null) {
        // 调用真实设备 API
        realDeviceApi.turnOn(device.getDeviceId());
        
        // 更新数据库状态
        device.setPowerState("on");
        deviceRepository.save(device);
    }
    return device;
}
```

## 📞 获取帮助

### 查看日志

日志文件位置：`logs/spring.log`

查看实时日志：
```bash
tail -f logs/spring.log
```

### 提交问题

如遇到问题，请提供：
1. 错误信息或日志
2. 操作步骤
3. 环境信息（JDK 版本、MySQL 版本等）

### 参考资源

- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)
- [天猫精灵开放平台](https://aligenie.com)
- [小度开放平台](https://dueros.baidu.com)
- [小米 IoT 平台](https://iot.mi.com)

## 🎉 开始使用

现在你已经了解了项目的基本使用方法，可以：

1. 启动项目并测试接口
2. 阅读详细文档了解更多细节
3. 根据需求扩展功能
4. 部署到生产环境

祝你使用愉快！🚀
