# 天猫精灵功能测试指南

## 测试环境准备

### 1. 确保服务已启动
```bash
# 检查服务是否运行
curl http://localhost:8080/actuator/health
```

### 2. 确保测试数据已导入
```bash
# Windows
import-test-data.bat

# Linux/Mac
./import-test-data.sh
```

## 测试方法

### 方法一：使用批处理脚本（推荐新手）

1. 双击运行 `test-aligenie.bat`
2. 按照提示操作：
   - 首先会获取访问令牌
   - 复制返回的 `access_token` 值
   - 输入令牌后继续测试
3. 脚本会自动执行所有测试用例

### 方法二：使用 Postman（推荐）

1. **导入测试集合**
   - 打开 Postman
   - 点击 Import
   - 选择 `Aligenie_Test_Collection.json`

2. **执行测试**
   - 先运行 "1. 获取访问令牌"
   - Token 会自动保存到集合变量
   - 依次运行其他测试用例

3. **批量测试**
   - 点击集合右侧的 "..." 按钮
   - 选择 "Run collection"
   - 点击 "Run" 执行所有测试

### 方法三：使用 curl 命令

#### 步骤 1：获取访问令牌
```bash
curl -X POST "http://localhost:8080/oauth2/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id=aligenie-client&client_secret=aligenie-secret&scope=device:control,device:read"
```

保存返回的 `access_token`。

#### 步骤 2：设备发现
```bash
curl -X POST "http://localhost:8080/aligenie/discovery" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Discovery",
      "name": "DiscoveryDevices",
      "messageId": "test-001",
      "payloadVersion": "1"
    },
    "payload": {}
  }'
```

#### 步骤 3：开机
```bash
curl -X POST "http://localhost:8080/aligenie/control" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "TurnOn",
      "messageId": "test-002",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "robot_001"
    }
  }'
```

#### 步骤 4：关机
```bash
curl -X POST "http://localhost:8080/aligenie/control" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "TurnOff",
      "messageId": "test-003",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "robot_001"
    }
  }'
```

#### 步骤 5：暂停
```bash
curl -X POST "http://localhost:8080/aligenie/control" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "Pause",
      "messageId": "test-004",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "robot_001"
    }
  }'
```

#### 步骤 6：继续
```bash
curl -X POST "http://localhost:8080/aligenie/control" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "Continue",
      "messageId": "test-005",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "robot_001"
    }
  }'
```

#### 步骤 7：设置模式
```bash
curl -X POST "http://localhost:8080/aligenie/control" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Control",
      "name": "SetMode",
      "messageId": "test-006",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "robot_001",
      "mode": "auto"
    }
  }'
```

#### 步骤 8：查询状态
```bash
curl -X POST "http://localhost:8080/aligenie/query" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "header": {
      "namespace": "AliGenie.Iot.Device.Query",
      "name": "Query",
      "messageId": "test-007",
      "payloadVersion": "1"
    },
    "payload": {
      "deviceId": "robot_001"
    }
  }'
```

## 预期结果

### 1. 设备发现响应
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Discovery",
    "name": "DiscoveryDevicesResponse",
    "messageId": "test-001",
    "payloadVersion": "1"
  },
  "payload": {
    "devices": [
      {
        "deviceId": "robot_001",
        "deviceName": "客厅扫地机器人",
        "deviceType": "vacuum",
        "zone": "客厅",
        "brand": "Demo",
        "model": "V1.0",
        "icon": "https://example.com/icon.png",
        "properties": [...],
        "actions": [...]
      }
    ]
  }
}
```

### 2. 控制命令响应（成功）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Control",
    "name": "TurnOnConfirmation",
    "messageId": "test-002",
    "payloadVersion": "1"
  },
  "payload": {}
}
```

### 3. 查询响应
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Query",
    "name": "QueryResponse",
    "messageId": "test-007",
    "payloadVersion": "1"
  },
  "payload": {
    "deviceId": "robot_001",
    "powerState": "ON",
    "workMode": "auto",
    "batteryLevel": 85
  }
}
```

### 4. 错误响应（无效令牌）
```json
{
  "header": {
    "namespace": "AliGenie.Iot.Device.Error",
    "name": "ErrorResponse",
    "messageId": "test-001",
    "payloadVersion": "1"
  },
  "payload": {
    "errorCode": "INVALID_TOKEN",
    "message": "访问令牌无效或已过期"
  }
}
```

## 测试检查清单

- [ ] 获取访问令牌成功
- [ ] 设备发现返回设备列表
- [ ] 开机命令执行成功
- [ ] 关机命令执行成功
- [ ] 暂停命令执行成功
- [ ] 继续命令执行成功
- [ ] 设置模式命令执行成功（auto）
- [ ] 设置模式命令执行成功（spot）
- [ ] 设置模式命令执行成功（edge）
- [ ] 查询设备状态成功
- [ ] 无效令牌返回 401 错误
- [ ] 不存在的设备返回错误
- [ ] 不支持的操作返回错误

## 常见问题

### 1. 401 Unauthorized
- 检查 access_token 是否正确
- 检查 token 是否已过期
- 确认 Authorization header 格式：`Bearer YOUR_TOKEN`

### 2. 404 Not Found
- 检查 URL 路径是否正确
- 确认服务已启动在 8080 端口

### 3. 设备不存在
- 确认测试数据已导入
- 检查 deviceId 是否正确（应为 robot_001, robot_002 等）

### 4. 数据库连接失败
- 检查 MySQL 服务是否运行
- 确认数据库配置正确（application.yml）

## 查看日志

测试时可以查看应用日志：
```bash
# 查看最新日志
tail -f logs/voice-platform.log

# 或在控制台查看
# 日志会显示每个请求的详细信息
```

## 下一步

测试通过后，可以：
1. 测试其他平台（小度、小爱、Alexa、Google）
2. 进行压力测试
3. 测试异常场景
4. 集成到 CI/CD 流程
